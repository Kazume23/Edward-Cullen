<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Habit tracker</title>
  <link rel="stylesheet" href="style/style.css">
</head>

<body>
  <div class="app">
    <div class="sidebar">
      <div class="logo">
        <span class="logoMark" aria-hidden="true"></span>
        <span class="logoText">Edward</span>
      </div>

      <div class="nav">
        <div class="navRow">
          <button class="navItem" id="navDash" type="button">Dashboard</button>
        </div>

        <div class="navRow">
          <button class="navItem" id="navTodo" type="button">ToDo</button>
          <button class="navAddBtn" id="navAddTodo" type="button" title="Dodaj ToDo" aria-label="Dodaj ToDo">+</button>
        </div>

        <div class="navRow">
          <button class="navItem" id="navHabits" type="button">Nawyki</button>
          <button class="navAddBtn" id="navAddHabits" type="button" title="Dodaj nawyk" aria-label="Dodaj nawyk">+</button>
        </div>

        <div class="navRow">
          <button class="navItem" id="navExpenses" type="button">Wydatki</button>
          <button class="navAddBtn" id="navAddExpenses" type="button" title="Dodaj wydatek" aria-label="Dodaj wydatek">+</button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="topbar">
        <div class="title"></div>
          <div class="icons">
            <button class="icon iconBtn" id="langBtn" type="button" title="Zmień język">PL</button>
            <a class="icon iconBtn" id="ghBtn" href="https://github.com/Kazume23/Edward-Cullen" target="_blank" rel="noreferrer" title="GitHub">GH</a>
          </div>
      </div>
    <div class="content">  
      <div class="box topA">
        <div class="chartHeader">
          <div class="panelTitle">Bilans nawyków</div>
        
          <div class="chartToggle" role="tablist" aria-label="Zakres wykresu">
            <button class="chartTab isActive" id="chartWeek" type="button">Tydzień</button>
            <button class="chartTab" id="chartMonth" type="button">Miesiąc</button>
          </div>
        </div>
      
        <div class="panelBody">
          <div class="chartWrap">
            <svg id="chartSvg" class="chartSvg" viewBox="0 0 220 220" aria-label="Wykres bilansu"></svg>
          
            <div class="chartMeta">
              <div class="chartRange" id="chartRangeTxt"></div>
            
              <div class="chartLegend">
                <div class="legendRow">
                  <span class="legendDot done"></span>
                  <span>Wykonane:</span>
                  <b id="chartDone">0</b>
                </div>
                <div class="legendRow">
                  <span class="legendDot fail"></span>
                  <span>Zawalone:</span>
                  <b id="chartFail">0</b>
                </div>
                <div class="legendRow">
                  <span class="legendDot empty"></span>
                  <span>Puste:</span>
                  <b id="chartEmpty">0</b>
                </div>
              </div>
            
              <div class="chartSmall" id="chartSmallTxt"></div>
              <div class="chartActions">
                <button class="habBtn" id="chartDetailsBtn" type="button">Szczegóły</button>
              </div>
            </div>
          </div>
        </div>
      </div>


        <div class="box topB">
          <div class="cal">
            <div class="calHeader">
              <button class="calBtn" id="calPrev" type="button">‹</button>
              <div class="calTitle" id="calTitle">Miesiąc 2026</div>
              <div class="calRight">
                <button class="calBtn" id="calToday" type="button" data-i18n="cal.today">Dziś</button>
                <button class="calBtn" id="calNext" type="button">›</button>
              </div>
            </div>

            <div class="calWeekdays">
              <div data-i18n="cal.wd.mon">PN</div>
              <div data-i18n="cal.wd.tue">WT</div>
              <div data-i18n="cal.wd.wed">ŚR</div>
              <div data-i18n="cal.wd.thu">CZ</div>
              <div data-i18n="cal.wd.fri">PT</div>
              <div data-i18n="cal.wd.sat">SB</div>
              <div data-i18n="cal.wd.sun">ND</div>
            </div>

            <div class="calGrid" id="calGrid"></div>
          </div>
        </div>

        <div class="tableBox">
          <div class="habHeader">
            <div class="habHeaderLeft">
              <div class="habTitle">Habit tracker</div>
              <div class="habRange" id="habRange"></div>
            </div>

            <div class="habAdd">
              <input class="habInput" id="habitName" placeholder="Dodaj nawyk..." data-i18n-placeholder="hab.addPlaceholder" autocomplete="off">
              <button class="habBtn" id="addHabit" type="button" data-i18n="common.add">Dodaj</button>
            </div>
          </div>

          <div class="habTableWrap">
            <table class="habTable" id="habTable">
              <thead id="habThead"></thead>
              <tbody id="habTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="sideBox">
          <div class="panelTitle" data-i18n="todo.title">ToDo</div>
          <div class="panelBody">
            <div id="todoEmpty" class="todoEmpty" data-i18n="todo.empty">Brak ToDo. Dwuklik w kalendarzu aby dodać.</div>
            <div id="todoList" class="todoList"></div>
          </div>
        </div>


        <div class="bottomBox">
          <div class="panelTitle" data-i18n="exp.title">Dziennik wydatków</div>
          <div class="panelBody">
            <div class="expHeader">
              <div class="expSummary" id="expSummary">Suma: 0,00 zł</div>

            </div>

            <div class="expForm">
              <input class="modalInput" id="expAmount" type="text" inputmode="numeric" placeholder="Kwota" data-i18n-placeholder="exp.amount" />
              <input class="modalInput" id="expWhat" type="text" placeholder="Co kupione" data-i18n-placeholder="exp.what">

              <select class="modalInput" id="expCategory">
                <option value="Jedzenie">Jedzenie</option>
                <option value="Transport">Transport</option>
                <option value="Rozrywka">Rozrywka</option>
                <option value="Zdrowie">Zdrowie</option>
                <option value="Edukacja">Edukacja</option>
                <option value="Sprzęt">Sprzęt</option>
                <option value="Subskrypcje">Subskrypcje</option>
                <option value="Inne">Inne</option>
              </select>

              <select class="modalInput" id="expScore">
                <option value="A">A — Wysoki priorytet</option>
                <option value="B">B — Konieczny</option>
                <option value="C">C — Opcjonalny</option>
                <option value="D">D — Zbędny</option>
              </select>

              <select class="modalInput" id="expPeriod">
                <option value="once">Jednorazowe</option>
                <option value="weekly">Tygodniowe</option>
                <option value="monthly">Miesięczne</option>
                <option value="yearly">Roczne</option>
              </select>

              <input class="modalInput" id="expDate" type="date">

              <button class="habBtn" id="expAdd" type="button" data-i18n="common.add">Dodaj</button>
            </div>

            <div class="expList" id="expList"></div>
          </div>
        </div>
      </div>
      </div>
    </div>
  </div>
  <div class="modalOverlay" id="todoOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="todoModalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="todoModalTitle" data-i18n="todo.modal.title">Dodaj ToDo</div>
        <button class="modalClose" id="todoClose" type="button" aria-label="Zamknij" data-i18n-aria="common.close">×</button>
      </div>

      <div class="modalBody">
        <label class="modalLabel" for="todoDate">Data</label>
        <input class="modalInput" id="todoDate" type="date">

        <label class="modalLabel" for="todoText">Treść</label>
        <textarea class="modalTextarea" id="todoText" placeholder="Wpisz ToDo..." rows="4"></textarea>

        <div class="modalActions">
          <button class="calBtn" id="todoCancel" type="button">Anuluj</button>
          <button class="habBtn" id="todoSave" type="button">Zapisz</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="chartOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="chartModalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="chartModalTitle">Bilans nawyków</div>
        <button class="modalClose" id="chartClose" type="button" aria-label="Zamknij">×</button>
      </div>

      <div class="modalBody chartModalBody">
        <div class="chartModalRange" id="chartModalRange"></div>
        <div class="chartModalList" id="chartModalList"></div>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="habitOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="habitModalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="habitModalTitle">Dodaj nawyk</div>
        <button class="modalClose" id="habitClose" type="button" aria-label="Zamknij">×</button>
      </div>

      <div class="modalBody">
        <label class="modalLabel" for="habitModalName">Nazwa</label>
        <input class="modalInput" id="habitModalName" type="text" placeholder="Np. Wstać o 6:00" autocomplete="off">

        <div class="modalActions">
          <button class="calBtn" id="habitCancel" type="button">Anuluj</button>
          <button class="habBtn" id="habitSave" type="button">Dodaj</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="expOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="expModalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="expModalTitle">Dodaj wydatek</div>
        <button class="modalClose" id="expClose" type="button" aria-label="Zamknij">×</button>
      </div>

      <div class="modalBody">
        <label class="modalLabel" for="expModalAmount">Kwota</label>
        <input class="modalInput" id="expModalAmount" type="text" inputmode="numeric" placeholder="Np. 12,50">

        <label class="modalLabel" for="expModalWhat">Co kupione</label>
        <input class="modalInput" id="expModalWhat" type="text" placeholder="Np. Kawa">

        <label class="modalLabel" for="expModalCategory">Kategoria</label>
        <select class="modalInput" id="expModalCategory">
          <option value="Jedzenie">Jedzenie</option>
          <option value="Transport">Transport</option>
          <option value="Rozrywka">Rozrywka</option>
          <option value="Zdrowie">Zdrowie</option>
          <option value="Edukacja">Edukacja</option>
          <option value="Sprzęt">Sprzęt</option>
          <option value="Subskrypcje">Subskrypcje</option>
          <option value="Inne">Inne</option>
        </select>

        <label class="modalLabel" for="expModalScore">Ocena</label>
        <select class="modalInput" id="expModalScore">
          <option value="A">A  Wysoki priorytet</option>
          <option value="B">B  Konieczny</option>
          <option value="C">C  Opcjonalny</option>
          <option value="D">D  Zbędny</option>
        </select>

        <label class="modalLabel" for="expModalPeriod">Okres</label>
        <select class="modalInput" id="expModalPeriod">
          <option value="once">Jednorazowe</option>
          <option value="weekly">Tygodniowe</option>
          <option value="monthly">Miesięczne</option>
          <option value="yearly">Roczne</option>
        </select>

        <label class="modalLabel" for="expModalDate">Data</label>
        <input class="modalInput" id="expModalDate" type="date">

        <div class="modalActions">
          <button class="calBtn" id="expCancel" type="button">Anuluj</button>
          <button class="habBtn" id="expSave" type="button">Dodaj</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const LS_KEY = "habit_app_v1";

    const $ = (id) => document.getElementById(id);

    const calTitle = $("calTitle");
    const calGrid = $("calGrid");
    const btnPrev = $("calPrev");
    const btnNext = $("calNext");
    const btnToday = $("calToday");

    const habRange = $("habRange");
    const habThead = $("habThead");
    const habTbody = $("habTbody");
    const habitName = $("habitName");
    const addHabitBtn = $("addHabit");

    const todoEmpty = $("todoEmpty");
    const todoList = $("todoList");

    const todoOverlay = $("todoOverlay");
    const todoDateInput = $("todoDate");
    const todoText = $("todoText");
    const todoSave = $("todoSave");
    const todoClose = $("todoClose");
    const todoCancel = $("todoCancel");

    const chartSvg = $("chartSvg");
    const chartWeekBtn = $("chartWeek");
    const chartMonthBtn = $("chartMonth");
    const chartRangeTxt = $("chartRangeTxt");
    const chartDoneTxt = $("chartDone");
    const chartFailTxt = $("chartFail");
    const chartEmptyTxt = $("chartEmpty");
    const chartSmallTxt = $("chartSmallTxt");

    const chartDetailsBtn = $("chartDetailsBtn");
    const chartOverlay = $("chartOverlay");
    const chartClose = $("chartClose");
    const chartModalRange = $("chartModalRange");
    const chartModalList = $("chartModalList");



    function pad2(n) { return String(n).padStart(2, "0"); }
    function toISO(d) { return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`; }
    function fromISO(iso) {
      const [y, m, d] = iso.split("-").map(Number);
      return new Date(y, m - 1, d);
    }
    function startOfDay(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function addDays(d, n) { const x = new Date(d); x.setDate(x.getDate() + n); return x; }
    function sameDay(a, b) {
      return a.getFullYear() === b.getFullYear() &&
        a.getMonth() === b.getMonth() &&
        a.getDate() === b.getDate();
    }
    function startOfWeekMonday(d) {
      const x = startOfDay(d);
      const day = x.getDay(); // 0 ND, 1 PN
      const diff = (day === 0 ? -6 : 1) - day;
      return addDays(x, diff);
    }
    function monthNamePL(m) {
      return ["Styczeń", "Luty", "Marzec", "Kwiecień", "Maj", "Czerwiec", "Lipiec", "Sierpień", "Wrzesień", "Październik", "Listopad", "Grudzień"][m];
    }
    function fmtPL(d) { return `${pad2(d.getDate())}.${pad2(d.getMonth() + 1)}.${d.getFullYear()}`; }

    function loadState() {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) {
        const today = startOfDay(new Date());
        return {
          habits: [
            { id: crypto.randomUUID(), name: "Wstać o 6:00" },
            { id: crypto.randomUUID(), name: "Trening" },
            { id: crypto.randomUUID(), name: "Czytanie" }
          ],
          entries: {},
          todos: [],
          selectedDate: toISO(today),
          viewMonth: today.getMonth(),
          viewYear: today.getFullYear(),
          chartMode: "week"
        };
      }
      try {
        const s = JSON.parse(raw);
        if (!s.habits) s.habits = [];
        if (!s.entries) s.entries = {};
        if (!s.todos) s.todos = [];
        if (!s.expenses) s.expenses = [];
        if (!s.selectedDate) s.selectedDate = toISO(startOfDay(new Date()));
        if (typeof s.viewMonth !== "number") s.viewMonth = new Date().getMonth();
        if (typeof s.viewYear !== "number") s.viewYear = new Date().getFullYear();
        if (!s.chartMode) s.chartMode = "week";
        if (s.chartMode !== "week" && s.chartMode !== "month") {
          s.chartMode = "week";
        }
        return s;
      } catch {
        localStorage.removeItem(LS_KEY);
        return loadState();
      }
    }

    function saveState() {
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    let state = loadState();

    function getSelectedDateObj() { return fromISO(state.selectedDate); }

    function setSelectedDate(d) {
      const x = startOfDay(d);
      state.selectedDate = toISO(x);
      state.viewMonth = x.getMonth();
      state.viewYear = x.getFullYear();
      saveState();
      renderAll();
    }

    function setViewMonthYear(y, m) {
      state.viewYear = y;
      state.viewMonth = m;
      saveState();
      renderCalendar();
    }

    function buildMonthGrid(y, m) {
      const first = new Date(y, m, 1);
      const start = startOfWeekMonday(first);
      const days = [];
      for (let i = 0; i < 42; i++) days.push(addDays(start, i));
      return days;
    }

    function openTodoModal(dateObj) {
      todoDateInput.value = toISO(dateObj);
      todoText.value = "";
      todoOverlay.classList.add("isOpen");
      todoOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => todoText.focus(), 0);
    }

    function closeTodoModal() {
      todoOverlay.classList.remove("isOpen");
      todoOverlay.setAttribute("aria-hidden", "true");
    }

    function openChartModal() {
      chartOverlay.classList.add("isOpen");
      chartOverlay.setAttribute("aria-hidden", "false");
    }
    
    function closeChartModal() {
      chartOverlay.classList.remove("isOpen");
      chartOverlay.setAttribute("aria-hidden", "true");
    }
    
    function makeChartRow(idx, name, donePct, failPct) {
      const row = document.createElement("div");
      row.className = "chartRow";
    
      const n = document.createElement("div");
      n.className = "chartRowIdx";
      n.textContent = String(idx);
    
      const nm = document.createElement("div");
      nm.className = "chartRowName";
      nm.textContent = name || "Nawyk";
    
      const badges = document.createElement("div");
      badges.className = "chartRowBadges";
    
      const bDone = document.createElement("div");
      bDone.className = "chartBadge done";
      bDone.innerHTML = `<span class="dot"></span><span>${donePct}%</span>`;
    
      const bFail = document.createElement("div");
      bFail.className = "chartBadge fail";
      bFail.innerHTML = `<span class="dot"></span><span>${failPct}%</span>`;
    
      badges.appendChild(bDone);
      badges.appendChild(bFail);
    
      row.appendChild(n);
      row.appendChild(nm);
      row.appendChild(badges);
    
      return row;
    }
    
    function renderChartModal(stats) {
      chartModalList.innerHTML = "";
      chartModalRange.textContent = chartRangeTxt.textContent || "";
    
      const list = stats.perHabit || [];
      list.forEach((h, i) => {
        chartModalList.appendChild(
          makeChartRow(i + 1, h.name, h.donePct, h.failPct)
        );
      });
    }


    function addTodo(dateISO, text) {
      const t = String(text || "").trim();
      if (!t) return;

      state.todos.push({
        id: crypto.randomUUID(),
        dateISO,
        text: t,
        done: false,
        createdAt: Date.now()
      });

      saveState();
      renderTodos();
    }

    function toggleTodo(id) {
      const it = state.todos.find(x => x.id === id);
      if (!it) return;
      it.done = !it.done;
      saveState();
      renderTodos();
    }

    function deleteTodo(id) {
      state.todos = state.todos.filter(x => x.id !== id);
      saveState();
      renderTodos();
    }

    function renderTodos() {
      todoList.innerHTML = "";

      const items = [...state.todos].sort((a, b) => {
        if (a.dateISO !== b.dateISO) return a.dateISO.localeCompare(b.dateISO);
        return (a.createdAt || 0) - (b.createdAt || 0);
      });

      if (!items.length) {
        todoEmpty.style.display = "block";
        return;
      }
      todoEmpty.style.display = "none";

      for (const it of items) {
        const row = document.createElement("div");
        row.className = "todoItem";
        if (it.done) row.classList.add("todoDone");

        const left = document.createElement("div");
        left.className = "todoLeft";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "todoCheck";
        cb.checked = !!it.done;
        cb.addEventListener("change", () => toggleTodo(it.id));

        const textBox = document.createElement("div");

        const txt = document.createElement("div");
        txt.className = "todoText";
        txt.textContent = it.text;

        const meta = document.createElement("div");
        meta.className = "todoMeta";
        meta.textContent = fmtPL(fromISO(it.dateISO));

        textBox.appendChild(txt);
        textBox.appendChild(meta);

        left.appendChild(cb);
        left.appendChild(textBox);

        const del = document.createElement("button");
        del.type = "button";
        del.className = "todoDel";
        del.textContent = "×";
        del.title = "Usuń";
        del.addEventListener("click", () => deleteTodo(it.id));

        row.appendChild(left);
        row.appendChild(del);

        todoList.appendChild(row);
      }
    }

    function renderCalendar() {
      calTitle.textContent = `${monthNamePL(state.viewMonth)} ${state.viewYear}`;
      calGrid.innerHTML = "";

      const days = buildMonthGrid(state.viewYear, state.viewMonth);
      const selected = getSelectedDateObj();
      const weekStart = startOfWeekMonday(selected);
      const weekEnd = addDays(weekStart, 6);

      for (const d of days) {
        const cell = document.createElement("button");
        cell.type = "button";
        cell.className = "calDay";

        const inMonth = d.getMonth() === state.viewMonth;
        if (!inMonth) cell.classList.add("calMuted");

        if (sameDay(d, selected)) cell.classList.add("calSelected");
        if (d >= weekStart && d <= weekEnd) cell.classList.add("calWeek");

        cell.textContent = String(d.getDate());

        cell.addEventListener("click", () => setSelectedDate(d));
        cell.addEventListener("dblclick", (e) => {
          e.preventDefault();
          setSelectedDate(d);
          openTodoModal(d);
        });

        calGrid.appendChild(cell);
      }
    }

    function cycleEntry(habitId, dateISO) {
      const key = `${habitId}|${dateISO}`;
      const cur = state.entries[key] ?? 0;

      let next = 0;
      if (cur === 0) next = 1;
      else if (cur === 1) next = -1;
      else next = 0;

      if (next === 0) delete state.entries[key];
      else state.entries[key] = next;

      saveState();
      renderHabits();
      renderChart();
    }

    function deleteHabit(habitId) {
      state.habits = state.habits.filter(h => h.id !== habitId);
      for (const k of Object.keys(state.entries)) {
        if (k.startsWith(habitId + "|")) delete state.entries[k];
      }
      saveState();
      renderHabits();
      renderChart();
    }

    function renderHabits() {
      const selected = getSelectedDateObj();
      const weekStart = startOfWeekMonday(selected);
      const weekDates = Array.from({ length: 7 }, (_, i) => addDays(weekStart, i));

      habRange.textContent = `${fmtPL(weekStart)} do ${fmtPL(addDays(weekStart, 6))}`;

      const trHead = document.createElement("tr");

      const thHabit = document.createElement("th");
      thHabit.textContent = "Nawyk";
      thHabit.className = "thHabit";
      trHead.appendChild(thHabit);

      const thDel = document.createElement("th");
      thDel.textContent = "";
      thDel.style.width = "44px";
      trHead.appendChild(thDel);

      for (const d of weekDates) {
        const th = document.createElement("th");
        th.className = "thDay";
        th.textContent = `${pad2(d.getDate())}.${pad2(d.getMonth() + 1)}`;
        if (sameDay(d, selected)) th.classList.add("thToday");
        trHead.appendChild(th);
      }

      habThead.innerHTML = "";
      habThead.appendChild(trHead);

      habTbody.innerHTML = "";
      for (const h of state.habits) {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.className = "tdHabit";

        const name = document.createElement("div");
        name.className = "habitName";
        name.contentEditable = "true";
        name.spellcheck = false;
        name.textContent = h.name;

        name.addEventListener("blur", () => {
          const v = name.textContent.trim();
          h.name = v.length ? v : "Nawyk";
          saveState();
        });
        name.addEventListener("keydown", (e) => {
          if (e.key === "Enter") { e.preventDefault(); name.blur(); }
        });

        tdName.appendChild(name);
        tr.appendChild(tdName);

        const tdDel = document.createElement("td");
        tdDel.className = "tdCell";

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "habitDel";
        delBtn.textContent = "×";
        delBtn.title = "Usuń nawyk";
        delBtn.addEventListener("click", () => deleteHabit(h.id));

        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);

        for (const d of weekDates) {
          const dateISO = toISO(d);
          const key = `${h.id}|${dateISO}`;
          const val = state.entries[key] ?? 0;

          const td = document.createElement("td");
          td.className = "tdCell";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "cellBtn";
          if (val === 1) btn.classList.add("cellDone");
          if (val === -1) btn.classList.add("cellFail");

          btn.addEventListener("click", () => cycleEntry(h.id, dateISO));
          td.appendChild(btn);
          tr.appendChild(td);
        }

        habTbody.appendChild(tr);
      }
    }

    function addHabit() {
      const name = habitName.value.trim();
      if (!name) return;
      state.habits.push({ id: crypto.randomUUID(), name });
      habitName.value = "";
      saveState();
      renderHabits();
      renderChart();
    }

    addHabitBtn.addEventListener("click", addHabit);
    habitName.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addHabit();
    });

    btnPrev.addEventListener("click", () => {
      let y = state.viewYear;
      let m = state.viewMonth - 1;
      if (m < 0) { m = 11; y -= 1; }
      setViewMonthYear(y, m);
    });

    btnNext.addEventListener("click", () => {
      let y = state.viewYear;
      let m = state.viewMonth + 1;
      if (m > 11) { m = 0; y += 1; }
      setViewMonthYear(y, m);
    });

    btnToday.addEventListener("click", () => {
      setSelectedDate(new Date());
    });

    todoClose.addEventListener("click", closeTodoModal);
    todoCancel.addEventListener("click", closeTodoModal);

    todoOverlay.addEventListener("click", (e) => {
      if (e.target === todoOverlay) closeTodoModal();
    });

    document.addEventListener("keydown", (e) => {
      if (todoOverlay.classList.contains("isOpen") && e.key === "Escape") closeTodoModal();
    });

    todoSave.addEventListener("click", () => {
      addTodo(todoDateInput.value, todoText.value);
      closeTodoModal();
    });
    chartDetailsBtn.addEventListener("click", () => {
      const s = computeChartStats();
      renderChartModal(s);
      openChartModal();
    });

    chartClose.addEventListener("click", closeChartModal);

    chartOverlay.addEventListener("click", (e) => {
      if (e.target === chartOverlay) closeChartModal();
    });

    document.addEventListener("keydown", (e) => {
      if (chartOverlay.classList.contains("isOpen") && e.key === "Escape") closeChartModal();
    });

    const expOnlySelected = $("expOnlySelected");
    const expAmount = $("expAmount");
    const expWhat = $("expWhat");
    const expCategory = $("expCategory");
    const expScore = $("expScore");
    const expPeriod = $("expPeriod");
    const expDate = $("expDate");
    const expAdd = $("expAdd");
    const expList = $("expList");
    const expSummary = $("expSummary");

    
    expAmount.addEventListener("input", () => {
     let v = expAmount.value;
     v = v.replace(/[^0-9.,]/g, "");

     const parts = v.split(/[.,]/);
     if (parts[0].length > 9) {
       parts[0] = parts[0].slice(0, 9);
     }

     expAmount.value = parts.length > 1
       ? parts[0] + "," + parts[1].slice(0, 2)
       : parts[0];
    });
    
    function moneyPL(n) {
      const x = Number(n);
      if (!Number.isFinite(x)) return "0,00 zł";
      return x.toFixed(2).replace(".", ",") + " zł";
    }

    function ensureExpenses() {
      if (!state.expenses) state.expenses = [];
    }

    function getExpenseFilterISO() {
      return state.selectedDate;
    }

    function addExpense() {
      ensureExpenses();

      const amt = Number(String(expAmount.value || "").replace(",", "."));
      const what = String(expWhat.value || "").trim();
      const dateISO = expDate.value || getExpenseFilterISO();
      
      if (!Number.isFinite(amt) || amt <= 0) return;
      if (String(Math.floor(amt)).length > 10) return;
      if (!what) return;

      state.expenses.push({
        id: crypto.randomUUID(),
        dateISO,
        amount: amt,
        what,
        category: expCategory.value,
        score: expScore.value,
        period: expPeriod.value,
        createdAt: Date.now()
      });

      expAmount.value = "";
      expWhat.value = "";
      expPeriod.value = "once";

      saveState();
      renderExpenses();
      renderCalendar();
    }

    function deleteExpense(id) {
      ensureExpenses();
      state.expenses = state.expenses.filter(x => x.id !== id);
      saveState();
      renderExpenses();
      renderCalendar();
    }

    function renderExpenses() {
      ensureExpenses();

      const filterISO = getExpenseFilterISO();
      expDate.value = filterISO;

      const items = [...state.expenses];

      items.sort((a, b) => {
        if (a.dateISO !== b.dateISO) return b.dateISO.localeCompare(a.dateISO);
        return (b.createdAt || 0) - (a.createdAt || 0);
      });

      const sum = items_slice_sum(items);
      expSummary.textContent = "Suma: " + moneyPL(sum);

      expList.innerHTML = "";

      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "todoEmpty";
        empty.textContent = "Brak wpisów.";
        expList.appendChild(empty);
        return;
      }

      for (const it of items) {
        const row = document.createElement("div");
        row.className = "expItem";

        const amt = document.createElement("div");
        amt.className = "expAmt";
        amt.textContent = moneyPL(it.amount);

        const whatBox = document.createElement("div");
        const what = document.createElement("div");
        what.textContent = it.what;
        const meta = document.createElement("div");
        meta.className = "expMeta";
        meta.textContent = fmtPL(fromISO(it.dateISO));
        whatBox.appendChild(what);
        whatBox.appendChild(meta);

        const cat = document.createElement("div");
        cat.className = "expTag";
        cat.textContent = it.category;

        const score = document.createElement("div");
        score.className = "expTag";
        score.textContent = scoreLabel(it.score);

        const per = document.createElement("div");
        per.className = "expTag";
        per.textContent = periodLabel(it.period);

        const del = document.createElement("button");
        del.type = "button";
        del.className = "expDel";
        del.textContent = "×";
        del.title = "Usuń";
        del.addEventListener("click", () => deleteExpense(it.id));

        row.appendChild(amt);
        row.appendChild(whatBox);
        row.appendChild(cat);
        row.appendChild(score);
        row.appendChild(per);
        row.appendChild(del);

        expList.appendChild(row);
      }
    }

    function items_slice_sum(items) {
      let s = 0;
      for (const it of items) s += Number(it.amount) || 0;
      return s;
    }

    function scoreLabel(v) {
      if (v === "A") return "A — Wysoki priorytet";
      if (v === "B") return "B — Konieczny";
      if (v === "C") return "C — Opcjonalny";
      return "D — Zbędny";
    }

    function periodLabel(v) {
      if (v === "weekly") return "Tygodniowe";
      if (v === "monthly") return "Miesięczne";
      if (v === "yearly") return "Roczne";
      return "Jednorazowe";
    }

    expAdd.addEventListener("click", addExpense);

    expWhat.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addExpense();
    });

    function monthRangeForSelected() {
    const d = getSelectedDateObj();
    const y = d.getFullYear();
    const m = d.getMonth();
    const start = new Date(y, m, 1);
    const end = new Date(y, m + 1, 0);
    return { start, end };
  }
  
  function rangeForChart() {
    const selected = getSelectedDateObj();
  
    if (state.chartMode === "month") {
      const { start, end } = monthRangeForSelected();
      return { start: startOfDay(start), end: startOfDay(end), daysCount: end.getDate() };
    }
  
    const weekStart = startOfWeekMonday(selected);
    return { start: startOfDay(weekStart), end: startOfDay(addDays(weekStart, 6)), daysCount: 7 };
  }
  
  function getEntryValue(habitId, dateISO) {
    const key = `${habitId}|${dateISO}`;
    return state.entries[key] ?? 0;
  }
  
  function computeChartStats() {
    const { start, end, daysCount } = rangeForChart();
    const totalCells = (state.habits?.length || 0) * daysCount;
  
  let done = 0;
  let fail = 0;

  const perHabit = state.habits.map(h => ({
    id: h.id,
    name: h.name,
    done: 0,
    fail: 0,
    donePct: 0,
    failPct: 0
  }));

  const perMap = Object.fromEntries(perHabit.map(x => [x.id, x]));

  for (let i = 0; i < daysCount; i++) {
    const d = addDays(start, i);
    const iso = toISO(d);

    for (const h of state.habits) {
      const v = getEntryValue(h.id, iso);

      if (v === 1) {
        done += 1;
        perMap[h.id].done += 1;
      } else if (v === -1) {
        fail += 1;
        perMap[h.id].fail += 1;
      }
    }
  }

  for (const x of perHabit) {
    x.donePct = daysCount > 0 ? Math.round((x.done / daysCount) * 100) : 0;
    x.failPct = daysCount > 0 ? Math.round((x.fail / daysCount) * 100) : 0;
  }
  
    const empty = Math.max(0, totalCells - done - fail);
  
    const coverage = totalCells > 0 ? Math.round(((done + fail) / totalCells) * 100) : 0;
    const donePerDay = daysCount > 0 ? (done / daysCount).toFixed(2) : "0.00";
    const failPerDay = daysCount > 0 ? (fail / daysCount).toFixed(2) : "0.00";
  
    return { start, end, daysCount, totalCells, done, fail, empty, coverage, donePerDay, failPerDay, perHabit };
  }
  
  function polarToCartesian(cx, cy, r, angleDeg) {
    const a = (angleDeg - 90) * Math.PI / 180;
    return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
  }
  
  function arcPath(cx, cy, r, startAngle, endAngle) {
    const start = polarToCartesian(cx, cy, r, endAngle);
    const end = polarToCartesian(cx, cy, r, startAngle);
    const large = (endAngle - startAngle) <= 180 ? "0" : "1";
    return `M ${start.x} ${start.y} A ${r} ${r} 0 ${large} 0 ${end.x} ${end.y}`;
  }
  
  function renderDonut(done, fail, empty) {
    const total = done + fail + empty;
  
    chartSvg.innerHTML = "";
  
    const cx = 110;
    const cy = 110;
    const r = 86;
  
    const ring = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    ring.setAttribute("cx", cx);
    ring.setAttribute("cy", cy);
    ring.setAttribute("r", r);
    ring.setAttribute("fill", "none");
    ring.setAttribute("stroke", "#3a3a3a");
    ring.setAttribute("stroke-width", "18");
    chartSvg.appendChild(ring);
  
    if (total <= 0) {
      const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
      t.setAttribute("x", cx);
      t.setAttribute("y", cy + 6);
      t.setAttribute("text-anchor", "middle");
      t.setAttribute("font-size", "14");
      t.setAttribute("fill", "#e7e7e7");
      t.textContent = "Brak danych";
      chartSvg.appendChild(t);
      return;
    }
  
    const parts = [
      { v: empty, stroke: "#555" },
      { v: fail, stroke: "#ff2f5d" },
      { v: done, stroke: "#2f9dff" }
    ].filter(p => p.v > 0);
  
    let angle = 0;
  
    for (const p of parts) {
      const span = (p.v / total) * 360;
      const startAngle = angle;
      const endAngle = angle + span;
    
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", arcPath(cx, cy, r, startAngle, endAngle));
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", p.stroke);
      path.setAttribute("stroke-width", "18");
      path.setAttribute("stroke-linecap", "round");
    
      chartSvg.appendChild(path);
    
      angle = endAngle;
    }
  
    const inner = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    inner.setAttribute("cx", cx);
    inner.setAttribute("cy", cy);
    inner.setAttribute("r", 58);
    inner.setAttribute("fill", "#2a2a2a");
    chartSvg.appendChild(inner);
  
    const center = document.createElementNS("http://www.w3.org/2000/svg", "text");
    center.setAttribute("x", cx);
    center.setAttribute("y", cy + 6);
    center.setAttribute("text-anchor", "middle");
    center.setAttribute("font-size", "16");
    center.setAttribute("fill", "#e7e7e7");
    center.textContent = `${Math.round((done / total) * 100)}%`;
    chartSvg.appendChild(center);
  }
  
  function syncChartTabs() {
    const isWeek = state.chartMode === "week";
    chartWeekBtn.classList.toggle("isActive", isWeek);
    chartMonthBtn.classList.toggle("isActive", !isWeek);
  }
  
  function renderChart() {
    const s = computeChartStats();
  
    chartDoneTxt.textContent = String(s.done);
    chartFailTxt.textContent = String(s.fail);
    chartEmptyTxt.textContent = String(s.empty);
  
    if (state.chartMode === "month") {
      chartRangeTxt.textContent = `${monthNamePL(getSelectedDateObj().getMonth())} ${getSelectedDateObj().getFullYear()}`;
    } else {
      chartRangeTxt.textContent = `${fmtPL(s.start)} do ${fmtPL(s.end)}`;
    }
  
    chartSmallTxt.textContent =
      `Aktywność: ${s.coverage}% komórek. ` +
      `Średnio na dzień: ✔ ${s.donePerDay}, ✖ ${s.failPerDay}.`;
  
    syncChartTabs();
    renderDonut(s.done, s.fail, s.empty);
  }
  
  chartWeekBtn.addEventListener("click", () => {
    state.chartMode = "week";
    saveState();
    renderChart();
  });
  
  chartMonthBtn.addEventListener("click", () => {
    state.chartMode = "month";
    saveState();
    renderChart();
  });

    const navDash = $("navDash");
    const navHabits = $("navHabits");
    const navTodo = $("navTodo");
    const navExpenses = $("navExpenses");

    const navAddHabits = $("navAddHabits");
    const navAddTodo = $("navAddTodo");
    const navAddExpenses = $("navAddExpenses");

    const boxTopA = document.querySelector(".box.topA");
    const tableBox = document.querySelector(".tableBox");
    const sideBox = document.querySelector(".sideBox");
    const bottomBox = document.querySelector(".bottomBox");

    sideBox.addEventListener("dblclick", () => {
      openTodoModal(getSelectedDateObj());
    });

    function scrollToEl(el){
      if (!el) return;
      el.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function setNavActive(btn){
      document.querySelectorAll(".navItem").forEach(x => x.classList.remove("isActive"));
      if (btn) btn.classList.add("isActive");
    }

    const habitOverlay = $("habitOverlay");
    const habitModalName = $("habitModalName");
    const habitSave = $("habitSave");
    const habitClose = $("habitClose");
    const habitCancel = $("habitCancel");

    function openHabitModal(){
      habitModalName.value = "";
      habitOverlay.classList.add("isOpen");
      habitOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => habitModalName.focus(), 0);
    }

    function closeHabitModal(){
      habitOverlay.classList.remove("isOpen");
      habitOverlay.setAttribute("aria-hidden", "true");
    }

    function addHabitFromModal(){
      const name = habitModalName.value.trim();
      if (!name) return;
      state.habits.push({ id: crypto.randomUUID(), name });
      saveState();
      renderHabits();
      renderChart();
      closeHabitModal();
    }

    habitSave.addEventListener("click", addHabitFromModal);
    habitClose.addEventListener("click", closeHabitModal);
    habitCancel.addEventListener("click", closeHabitModal);
    habitOverlay.addEventListener("click", (e) => {
      if (e.target === habitOverlay) closeHabitModal();
    });

    document.addEventListener("keydown", (e) => {
      if (habitOverlay.classList.contains("isOpen") && e.key === "Escape") closeHabitModal();
    });

    habitModalName.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addHabitFromModal();
    });

    const expOverlay = $("expOverlay");
    const expModalAmount = $("expModalAmount");
    const expModalWhat = $("expModalWhat");
    const expModalCategory = $("expModalCategory");
    const expModalScore = $("expModalScore");
    const expModalPeriod = $("expModalPeriod");
    const expModalDate = $("expModalDate");
    const expSaveBtn = $("expSave");
    const expCloseBtn = $("expClose");
    const expCancelBtn = $("expCancel");

    function openExpModal(){
      expModalAmount.value = "";
      expModalWhat.value = "";
      expModalCategory.value = "Jedzenie";
      expModalScore.value = "B";
      expModalPeriod.value = "once";
      expModalDate.value = state.selectedDate;

      expOverlay.classList.add("isOpen");
      expOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => expModalAmount.focus(), 0);
    }

    function closeExpModal(){
      expOverlay.classList.remove("isOpen");
      expOverlay.setAttribute("aria-hidden", "true");
    }

    expModalAmount.addEventListener("input", () => {
      let v = expModalAmount.value;
      v = v.replace(/[^0-9.,]/g, "");
      const parts = v.split(/[.,]/);
      if (parts[0].length > 9) parts[0] = parts[0].slice(0, 9);
      expModalAmount.value = parts.length > 1 ? parts[0] + "," + parts[1].slice(0, 2) : parts[0];
    });

    function addExpenseFromModal(){
      ensureExpenses();

      const amt = Number(String(expModalAmount.value || "").replace(",", "."));
      const what = String(expModalWhat.value || "").trim();
      const dateISO = expModalDate.value || state.selectedDate;

      if (!Number.isFinite(amt) || amt <= 0) return;
      if (String(Math.floor(amt)).length > 10) return;
      if (!what) return;

      state.expenses.push({
        id: crypto.randomUUID(),
        dateISO,
        amount: amt,
        what,
        category: expModalCategory.value,
        score: expModalScore.value,
        period: expModalPeriod.value,
        createdAt: Date.now()
      });

      saveState();
      renderExpenses();
      renderCalendar();
      closeExpModal();
    }

    expSaveBtn.addEventListener("click", addExpenseFromModal);
    expCloseBtn.addEventListener("click", closeExpModal);
    expCancelBtn.addEventListener("click", closeExpModal);
    expOverlay.addEventListener("click", (e) => {
      if (e.target === expOverlay) closeExpModal();
    });

    document.addEventListener("keydown", (e) => {
      if (expOverlay.classList.contains("isOpen") && e.key === "Escape") closeExpModal();
    });

    navDash.addEventListener("click", () => { setNavActive(navDash); scrollToEl(boxTopA); });
    navHabits.addEventListener("click", () => { setNavActive(navHabits); scrollToEl(tableBox); });
    navTodo.addEventListener("click", () => { setNavActive(navTodo); scrollToEl(sideBox); });
    navExpenses.addEventListener("click", () => { setNavActive(navExpenses); scrollToEl(bottomBox); });

    function closeQuickAdd(){
      quickAddMenu.classList.remove("isOpen");
      quickAddMenu.setAttribute("aria-hidden", "true");
    }

    function toggleQuickAdd(){
      const open = quickAddMenu.classList.toggle("isOpen");
      quickAddMenu.setAttribute("aria-hidden", open ? "false" : "true");
    }

    navAddHabits.addEventListener("click", (e) => {
      e.stopPropagation();
      setNavActive(navHabits);
      openHabitModal();
    });

    navAddTodo.addEventListener("click", (e) => {
      e.stopPropagation();
      setNavActive(navTodo);
      openTodoModal(getSelectedDateObj());
    });

    navAddExpenses.addEventListener("click", (e) => {
      e.stopPropagation();
      setNavActive(navExpenses);
      openExpModal();
    });

    navTodo.addEventListener("dblclick", () => {
      setNavActive(navTodo);
      openTodoModal(getSelectedDateObj());
    });

    navExpenses.addEventListener("dblclick", () => {
      setNavActive(navExpenses);
      openExpModal();
    });

    navHabits.addEventListener("dblclick", () => {
      setNavActive(navHabits);
      openHabitModal();
    });

    function renderAll() {
      renderCalendar();
      renderHabits();
      renderTodos();
      renderExpenses();
      renderChart();
    }

    setNavActive(navDash);
    renderAll();
  </script>



</body>

</html>