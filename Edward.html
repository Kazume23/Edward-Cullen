<!doctype html>
<html lang="pl">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Edward Tracker</title>
  <link rel="stylesheet" href="style/style.css" id="baseStyles">
  <link rel="stylesheet" href="style/theme-ira.css" id="themeStyles" disabled>
  <link rel="stylesheet" href="style/styletrybjasny1.css" id="themelight" disabled>
  <link rel="stylesheet" href="style/styletrybrozowy.css" id="themepink" disabled>
  <link rel="icon" type="image/png" href="favicon.png">
</head>

<body>
  <div class="app">
    <div class="sidebar">
      <div class="logo">
        <span class="logoMark" aria-hidden="true"></span>
        <span class="logoText">Edward</span>
      </div>

      <div class="nav">
        <div class="navRow">
          <button class="navItem" id="navDash" type="button">Dashboard</button>
        </div>

        <div class="navRow">
          <button class="navItem" id="navTodo" type="button">ToDo</button>
          <button class="navAddBtn" id="navAddTodo" type="button" title="Dodaj ToDo" aria-label="Dodaj ToDo">+</button>
        </div>

        <div class="navRow">
          <button class="navItem" id="navHabits" type="button">Nawyki</button>
          <button class="navAddBtn" id="navAddHabits" type="button" title="Dodaj nawyk" aria-label="Dodaj nawyk">+</button>
        </div>

        <div class="navRow">
          <button class="navItem" id="navExpenses" type="button">Wydatki</button>
          <button class="navAddBtn" id="navAddExpenses" type="button" title="Dodaj wydatek" aria-label="Dodaj wydatek">+</button>
        </div>

        <div class="navRow">
          <button class="navItem" id="navWishlist" type="button">Wishlist</button>
          <button class="navAddBtn" id="navAddWishlist" type="button" title="Dodaj do wishlisty" aria-label="Dodaj do wishlisty">+</button>
        </div>
      </div>
    </div>

    <div class="main">
      <div class="topbar">
        <div class="title"></div>
          <div class="icons">
            <button class="icon iconBtn" id="langBtn" type="button" title="Zmień język">
              <svg class="iconSvg" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor"
                  d="M12 2a10 10 0 1 0 .001 20.001A10 10 0 0 0 12 2Zm7.93 9h-3.1a15.6 15.6 0 0 0-1.2-5.02A8.03 8.03 0 0 1 19.93 11ZM12 4c.88 1.22 1.57 3.07 1.9 5H10.1c.33-1.93 1.02-3.78 1.9-5Zm-1.9 7h3.8c.1.64.1 1.31.1 2s0 1.36-.1 2h-3.8c-.1-.64-.1-1.31-.1-2s0-1.36.1-2Zm-1.73-5.02A15.6 15.6 0 0 0 7.17 11H4.07a8.03 8.03 0 0 1 4.3-5.02ZM4.07 13h3.1c.19 1.74.62 3.44 1.2 5.02A8.03 8.03 0 0 1 4.07 13Zm7.93 7c-.88-1.22-1.57-3.07-1.9-5h3.8c-.33 1.93-1.02 3.78-1.9 5Zm3.63-1.98A15.6 15.6 0 0 0 16.83 13h3.1a8.03 8.03 0 0 1-4.3 5.02Z"/>
              </svg>
            </button>

          <button class="icon iconBtn" id="themeBtn" type="button" title="Motyw">
              <svg class="iconSvg" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor"
                  d="M12 3a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V4a1 1 0 0 1 1-1Zm0 14a4 4 0 1 0 0-8 4 4 0 0 0 0 8Zm7-5a1 1 0 0 1 1-1h1a1 1 0 1 1 0 2h-1a1 1 0 0 1-1-1Zm-16 0a1 1 0 0 1 1-1H3a1 1 0 1 1 0 2h1a1 1 0 0 1-1-1Zm11.66 6.66a1 1 0 0 1 1.41 0l.7.7a1 1 0 0 1-1.41 1.41l-.7-.7a1 1 0 0 1 0-1.41ZM7.64 5.64a1 1 0 0 1 1.41 0l.7.7a1 1 0 0 1-1.41 1.41l-.7-.7a1 1 0 0 1 0-1.41Zm0 12.72a1 1 0 0 1 0-1.41l.7-.7a1 1 0 0 1 1.41 1.41l-.7.7a1 1 0 0 1-1.41 0Zm12.72-12.72a1 1 0 0 1 0 1.41l-.7.7a1 1 0 0 1-1.41-1.41l.7-.7a1 1 0 0 1 1.41 0Z"/>
              </svg>
            </button> 

            <a class="icon iconBtn" id="ghBtn"
              href="https://github.com/Kazume23/Edward-Cullen"
              target="_blank" rel="noreferrer"
              title="GitHub">

              <svg class="iconSvg" viewBox="0 0 24 24" aria-hidden="true">
                <path fill="currentColor"
                  d="M12 .5C5.73.5.5 5.74.5 12.02c0 5.11 3.29 9.43 7.86 10.96.58.11.79-.25.79-.56v-2.1c-3.2.7-3.87-1.38-3.87-1.38-.53-1.34-1.3-1.7-1.3-1.7-1.06-.73.08-.72.08-.72 1.17.08 1.79 1.2 1.79 1.2 1.04 1.78 2.73 1.27 3.4.97.1-.75.41-1.27.75-1.56-2.55-.29-5.23-1.28-5.23-5.68 0-1.26.45-2.29 1.19-3.1-.12-.29-.52-1.46.11-3.05 0 0 .97-.31 3.18 1.18a11.07 11.07 0 0 1 5.8 0c2.2-1.49 3.17-1.18 3.17-1.18.63 1.59.23 2.76.11 3.05.74.81 1.19 1.84 1.19 3.1 0 4.41-2.68 5.38-5.24 5.66.42.36.8 1.08.8 2.18v3.23c0 .31.21.67.8.56A11.52 11.52 0 0 0 23.5 12C23.5 5.74 18.27.5 12 .5z"/>
              </svg>
            </a>
          </div>
      </div>
    <div class="content">  
      <div class="box topA">
        <div class="chartHeader">
          <div class="panelTitle">Bilans nawyków</div>
        
          <div class="chartToggle" role="tablist" aria-label="Zakres wykresu">
            <button class="chartTab isActive" id="chartWeek" type="button">Tydzień</button>
            <button class="chartTab" id="chartMonth" type="button">Miesiąc</button>
          </div>
        </div>
      
        <div class="panelBody">
          <div class="chartWrap">
            <svg id="chartSvg" class="chartSvg" viewBox="0 0 220 220" aria-label="Wykres bilansu"></svg>
          
            <div class="chartMeta">
              <div class="chartRange" id="chartRangeTxt"></div>
            
              <div class="chartLegend">
                <div class="legendRow">
                  <span class="legendDot done"></span>
                  <span>Wykonane:</span>
                  <b id="chartDone">0</b>
                </div>
                <div class="legendRow">
                  <span class="legendDot fail"></span>
                  <span>Zawalone:</span>
                  <b id="chartFail">0</b>
                </div>
                <div class="legendRow">
                  <span class="legendDot empty"></span>
                  <span>Puste:</span>
                  <b id="chartEmpty">0</b>
                </div>
              </div>
              <div class="chartActions">
                <button class="habBtn" id="chartDetailsBtn" type="button">Szczegóły</button>
              </div>
            </div>
          </div>
        </div>
      </div>


        <div class="box topB">
          <div class="cal">
            <div class="calHeader">
              <button class="calBtn" id="calPrev" type="button">‹</button>
              <div class="calTitle" id="calTitle">Miesiąc 2026</div>
              <div class="calRight">
                <button class="calBtn" id="calToday" type="button" data-i18n="cal.today">Dziś</button>
                <button class="calBtn" id="calNext" type="button">›</button>
              </div>
            </div>

            <div class="calWeekdays">
              <div data-i18n="cal.wd.mon">PN</div>
              <div data-i18n="cal.wd.tue">WT</div>
              <div data-i18n="cal.wd.wed">ŚR</div>
              <div data-i18n="cal.wd.thu">CZ</div>
              <div data-i18n="cal.wd.fri">PT</div>
              <div data-i18n="cal.wd.sat">SB</div>
              <div data-i18n="cal.wd.sun">ND</div>
            </div>

            <div class="calGrid" id="calGrid"></div>
          </div>
        </div>

        <div class="tableBox">
          <div class="habHeader">
            <div class="habHeaderLeft">
              <div class="habTitle">Habit tracker</div>
              <div class="habRange" id="habRange"></div>
            </div>

            <div class="habAdd">
              <input class="habInput" id="habitName" placeholder="Dodaj nawyk..." data-i18n-placeholder="hab.addPlaceholder" autocomplete="off">
              <button class="habBtn" id="addHabit" type="button" data-i18n="common.add">Dodaj</button>
            </div>
          </div>

          <div class="habTableWrap">
            <table class="habTable" id="habTable">
              <thead id="habThead"></thead>
              <tbody id="habTbody"></tbody>
            </table>
          </div>
        </div>

          <div class="sideBox" id="todoBox">
            <div class="box pomoBox">
              <div class="panelTitle">Pomodoro</div>
              <div class="panelBody pomoBody">
                <div class="pomoMode">
                  <button class="pomoTab isActive" id="pomoFocus" type="button">Focus</button>
                  <button class="pomoTab" id="pomoBreak" type="button">Break</button>
                  <button class="pomoTab" id="pomoLong" type="button">Long</button>
                </div>

                <div class="pomoTime" id="pomoTime">25:00</div>

                <div class="pomoActions">
                  <button class="habBtn" id="pomoStart" type="button">Start</button>
                  <button class="habBtn" id="pomoReset" type="button">Reset</button>
                </div>

                <div class="pomoMeta">Sesja: <span id="pomoSession">0</span></div>
              </div>
            </div>
            <div class="box todoBox">
              <div class="panelTitle todoTitleRow">
                <div class="todoTitleText">
                  <span data-i18n="todo.title">ToDo</span>
                  <span class="todoTitleSub" id="todoTitleSub"></span>
                </div>

                <button type="button" class="todoAddBtn" id="todoAddBtn" aria-label="Dodaj ToDo">+</button>
              </div>

              <div class="panelBody">
                <div id="todoEmpty" class="todoEmpty" data-i18n="todo.empty">Brak ToDo. Dwuklik w kalendarzu aby dodać.</div>
                <div id="todoList" class="todoList"></div>
              </div>
            </div>
          </div>
            <div class="bottomBox">
              <div class="expWrap">
                <div class="panelTitle" data-i18n="exp.title">Dziennik wydatków</div>
                <div class="panelBody">
                  <div class="expHeader">
                    <div class="expSummary" id="expSummary">Suma: 0,00 zł</div>
                  </div>

                  <div class="expForm">
                    <input class="modalInput" id="expAmount" type="text" inputmode="numeric" placeholder="Kwota" data-i18n-placeholder="exp.amount" />
                    <input class="modalInput" id="expWhat" type="text" placeholder="Co kupione" data-i18n-placeholder="exp.what">

                    <select class="modalInput" id="expCategory">
                      <option value="Jedzenie">Jedzenie</option>
                      <option value="Transport">Transport</option>
                      <option value="Rozrywka">Rozrywka</option>
                      <option value="Zdrowie">Zdrowie</option>
                      <option value="Edukacja">Edukacja</option>
                      <option value="Sprzęt">Sprzęt</option>
                      <option value="Subskrypcje">Subskrypcje</option>
                      <option value="Inne">Inne</option>
                    </select>

                    <select class="modalInput" id="expScore">
                      <option value="A">A — Wysoki priorytet</option>
                      <option value="B">B — Konieczny</option>
                      <option value="C">C — Opcjonalny</option>
                      <option value="D">D — Zbędny</option>
                    </select>

                    <select class="modalInput" id="expPeriod">
                      <option value="once">Jednorazowe</option>
                      <option value="weekly">Tygodniowe</option>
                      <option value="monthly">Miesięczne</option>
                      <option value="yearly">Roczne</option>
                    </select>

                    <input class="modalInput" id="expDate" type="date">
                    <button class="habBtn" id="expAdd" type="button" data-i18n="common.add">Dodaj</button>
                  </div>

                  <div class="expList" id="expList"></div>
                </div>
              </div>

              <!-- WISHLIST -->
              <div class="wishWrap">
                <div class="panelTitle">Wishlist</div>
                <div class="panelBody">
                  <div class="wishForm">
                    <input class="modalInput" id="wishName" type="text" placeholder="Co chcesz kupić" autocomplete="off">
                    <input class="modalInput" id="wishPrice" type="text" inputmode="numeric" placeholder="Cena" autocomplete="off">
                    <button class="habBtn" id="wishAdd" type="button">Dodaj</button>
                  </div>

                  <div class="wishList" id="wishList"></div>
                </div>
              </div>
            </div>
        </div>
      </div>
    </div>
  <div class="modalOverlay" id="todoOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="todoModalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="todoModalTitle" data-i18n="todo.modal.title">Dodaj ToDo</div>
        <button class="modalClose" id="todoClose" type="button" aria-label="Zamknij" data-i18n-aria="common.close">×</button>
      </div>

      <div class="modalBody">
        <label class="modalLabel" for="todoDate">Data</label>
        <input class="modalInput" id="todoDate" type="date">

        <label class="modalLabel" for="todoText">Treść</label>
        <textarea class="modalTextarea" id="todoText" placeholder="Wpisz ToDo..." rows="4"></textarea>

        <div class="modalActions">
          <button class="calBtn" id="todoCancel" type="button">Anuluj</button>
          <button class="habBtn" id="todoSave" type="button">Zapisz</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="chartOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="chartModalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="chartModalTitle">Bilans nawyków</div>
        <button class="modalClose" id="chartClose" type="button" aria-label="Zamknij">×</button>
      </div>

      <div class="modalBody chartModalBody">
        <div class="chartModalRange" id="chartModalRange"></div>
        <div class="chartModalSummary" id="chartModalSummary"></div>
        <div class="chartModalList" id="chartModalList"></div>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="habitOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="habitModalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="habitModalTitle">Dodaj nawyk</div>
        <button class="modalClose" id="habitClose" type="button" aria-label="Zamknij">×</button>
      </div>

      <div class="modalBody">
        <label class="modalLabel" for="habitModalName">Nazwa</label>
        <input class="modalInput" id="habitModalName" type="text" placeholder="Np. Wstać o 6:00" autocomplete="off">

        <div class="modalActions">
          <button class="calBtn" id="habitCancel" type="button">Anuluj</button>
          <button class="habBtn" id="habitSave" type="button">Dodaj</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="expOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="expModalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="expModalTitle">Dodaj wydatek</div>
        <button class="modalClose" id="expClose" type="button" aria-label="Zamknij">×</button>
      </div>

      <div class="modalBody">
        <label class="modalLabel" for="expModalAmount">Kwota</label>
        <input class="modalInput" id="expModalAmount" type="text" inputmode="numeric" placeholder="Np. 12,50">

        <label class="modalLabel" for="expModalWhat">Co kupione</label>
        <input class="modalInput" id="expModalWhat" type="text" placeholder="Np. Kawa">

        <label class="modalLabel" for="expModalCategory">Kategoria</label>
        <select class="modalInput" id="expModalCategory">
          <option value="Jedzenie">Jedzenie</option>
          <option value="Transport">Transport</option>
          <option value="Rozrywka">Rozrywka</option>
          <option value="Zdrowie">Zdrowie</option>
          <option value="Edukacja">Edukacja</option>
          <option value="Sprzęt">Sprzęt</option>
          <option value="Subskrypcje">Subskrypcje</option>
          <option value="Inne">Inne</option>
        </select>

        <label class="modalLabel" for="expModalScore">Ocena</label>
        <select class="modalInput" id="expModalScore">
          <option value="A">A  Wysoki priorytet</option>
          <option value="B">B  Konieczny</option>
          <option value="C">C  Opcjonalny</option>
          <option value="D">D  Zbędny</option>
        </select>

        <label class="modalLabel" for="expModalPeriod">Okres</label>
        <select class="modalInput" id="expModalPeriod">
          <option value="once">Jednorazowe</option>
          <option value="weekly">Tygodniowe</option>
          <option value="monthly">Miesięczne</option>
          <option value="yearly">Roczne</option>
        </select>

        <label class="modalLabel" for="expModalDate">Data</label>
        <input class="modalInput" id="expModalDate" type="date">

        <div class="modalActions">
          <button class="calBtn" id="expCancel" type="button">Anuluj</button>
          <button class="habBtn" id="expSave" type="button">Dodaj</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modalOverlay" id="wishOverlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="wishModalTitle">
      <div class="modalTop">
        <div class="modalTitle" id="wishModalTitle">Dodaj do wishlisty</div>
        <button class="modalClose" id="wishClose" type="button" aria-label="Zamknij">×</button>
      </div>

      <div class="modalBody">
        <label class="modalLabel" for="wishModalName">Co chcesz kupić</label>
        <input class="modalInput" id="wishModalName" type="text" autocomplete="off">

        <label class="modalLabel" for="wishModalPrice">Cena</label>
        <input class="modalInput" id="wishModalPrice" type="text" inputmode="numeric" autocomplete="off" placeholder="Np. 123,45">

        <div class="modalActions">
          <button class="calBtn" id="wishCancel" type="button">Anuluj</button>
          <button class="habBtn" id="wishSave" type="button">Dodaj</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const LS_KEY = "habit_app_v1";

    const $ = (id) => document.getElementById(id);

   /* const THEME_KEY = "edward_theme_v1";
    const themeLink = document.getElementById("themeStyles");
    const themeBtn = document.getElementById("themeBtn");

    function applyTheme(themeName) {
      if (!themeLink) return;
      themeLink.disabled = (themeName !== "ira");
    }

    function getSavedTheme() {
      return localStorage.getItem(THEME_KEY) || "base";
    }

    function saveTheme(themeName) {
      localStorage.setItem(THEME_KEY, themeName);
    }

    applyTheme(getSavedTheme());

    if (themeBtn) {
      themeBtn.addEventListener("click", () => {
        const next = getSavedTheme() === "ira" ? "base" : "ira";
        saveTheme(next);
        applyTheme(next);
      });
    }*/

const THEME_KEY = "edward_theme_v1";

const themes = [
  "baseStyles",
  "themeStyles",
  "themelight",
  "themepink"
];

function applyTheme(themeId) {
  themes.forEach(id => {
    const link = document.getElementById(id);
    if (link) link.disabled = id !== themeId;
  });
}

function getSavedTheme() {
  return localStorage.getItem(THEME_KEY) || "baseStyles"; };

function saveTheme(themeId) {
  localStorage.setItem(THEME_KEY, themeId);}; 

const themeBtn = document.getElementById("themeBtn");
 applyTheme(getSavedTheme());

if (themeBtn) {
  themeBtn.addEventListener("click", () => {
    const current = getSavedTheme();
    const index = themes.indexOf(current);
    const next = themes[(index + 1) % themes.length];

    saveTheme(next);
    applyTheme(next);
  });
}

    const calTitle = $("calTitle");
    const calGrid = $("calGrid");
    const btnPrev = $("calPrev");
    const btnNext = $("calNext");
    const btnToday = $("calToday");

    const habRange = $("habRange");
    const habThead = $("habThead");
    const habTbody = $("habTbody");
    const habitName = $("habitName");
    const addHabitBtn = $("addHabit");

    const todoEmpty = $("todoEmpty");
    const todoList = $("todoList");

    const todoAddBtn = $("todoAddBtn");
    const todoTitleSub = $("todoTitleSub");

    const todoOverlay = $("todoOverlay");
    const todoDateInput = $("todoDate");
    const todoText = $("todoText");
    const todoSave = $("todoSave");
    const todoClose = $("todoClose");
    const todoCancel = $("todoCancel");

    const chartSvg = $("chartSvg");
    const chartWeekBtn = $("chartWeek");
    const chartMonthBtn = $("chartMonth");
    const chartRangeTxt = $("chartRangeTxt");
    const chartDoneTxt = $("chartDone");
    const chartFailTxt = $("chartFail");
    const chartEmptyTxt = $("chartEmpty");
    const chartSmallTxt = $("chartSmallTxt");

    const chartDetailsBtn = $("chartDetailsBtn");
    const chartOverlay = $("chartOverlay");
    const chartClose = $("chartClose");
    const chartModalRange = $("chartModalRange");
    const chartModalList = $("chartModalList");

    if (todoAddBtn) {
      todoAddBtn.addEventListener("click", () => openTodoModal(getSelectedDateObj()));
    }

    function pad2(n) { return String(n).padStart(2, "0"); }
    function toISO(d) { return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`; }
    function fromISO(iso) {
      const [y, m, d] = iso.split("-").map(Number);
      return new Date(y, m - 1, d);
    }
    function startOfDay(d) { return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }
    function addDays(d, n) { const x = new Date(d); x.setDate(x.getDate() + n); return x; }
    function sameDay(a, b) {
      return a.getFullYear() === b.getFullYear() &&
        a.getMonth() === b.getMonth() &&
        a.getDate() === b.getDate();
    }
    function startOfWeekMonday(d) {
      const x = startOfDay(d);
      const day = x.getDay(); // 0 ND, 1 PN
      const diff = (day === 0 ? -6 : 1) - day;
      return addDays(x, diff);
    }
    function monthNamePL(m) {
      return ["Styczeń", "Luty", "Marzec", "Kwiecień", "Maj", "Czerwiec", "Lipiec", "Sierpień", "Wrzesień", "Październik", "Listopad", "Grudzień"][m];
    }
    function fmtPL(d) { return `${pad2(d.getDate())}.${pad2(d.getMonth() + 1)}.${d.getFullYear()}`; }

    function loadState() {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) {
        const today = startOfDay(new Date());
        return {
          habits: [
            { id: crypto.randomUUID(), name: "Wstać o 6:00" },
            { id: crypto.randomUUID(), name: "Trening" },
            { id: crypto.randomUUID(), name: "Czytanie" }
          ],
          entries: {},
          todos: [],
          selectedDate: toISO(today),
          viewMonth: today.getMonth(),
          viewYear: today.getFullYear(),
          chartMode: "week"
        };
      }
      try {
        const s = JSON.parse(raw);
        if (!s.habits) s.habits = [];
        if (!s.entries) s.entries = {};
        if (!s.todos) s.todos = [];
        if (!s.expenses) s.expenses = [];
        if (!s.selectedDate) s.selectedDate = toISO(startOfDay(new Date()));
        if (typeof s.viewMonth !== "number") s.viewMonth = new Date().getMonth();
        if (typeof s.viewYear !== "number") s.viewYear = new Date().getFullYear();
        if (!s.chartMode) s.chartMode = "week";
        if (s.chartMode !== "week" && s.chartMode !== "month") {
          s.chartMode = "week";
        }
        return s;
      } catch {
        localStorage.removeItem(LS_KEY);
        return loadState();
      }
    }

    function saveState() {
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    let state = loadState();

    function getSelectedDateObj() { return fromISO(state.selectedDate); }

    function setSelectedDate(d) {
      const x = startOfDay(d);
      state.selectedDate = toISO(x);
      state.viewMonth = x.getMonth();
      state.viewYear = x.getFullYear();
      saveState();
      renderAll();
    }

    function setViewMonthYear(y, m) {
      state.viewYear = y;
      state.viewMonth = m;
      saveState();
      renderCalendar();
    }

    function buildMonthGrid(y, m) {
      const first = new Date(y, m, 1);
      const start = startOfWeekMonday(first);
      const days = [];
      for (let i = 0; i < 42; i++) days.push(addDays(start, i));
      return days;
    }

    function openTodoModal(dateObj) {
      todoDateInput.value = toISO(dateObj);
      todoText.value = "";
      todoOverlay.classList.add("isOpen");
      todoOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => todoText.focus(), 0);
    }

    function closeTodoModal() {
      todoOverlay.classList.remove("isOpen");
      todoOverlay.setAttribute("aria-hidden", "true");
    }

    function openChartModal() {
      chartOverlay.classList.add("isOpen");
      chartOverlay.setAttribute("aria-hidden", "false");
    }
    
    function closeChartModal() {
      chartOverlay.classList.remove("isOpen");
      chartOverlay.setAttribute("aria-hidden", "true");
    }
    
    function makeChartRow(idx, name, donePct, failPct) {
      const row = document.createElement("div");
      row.className = "chartRow";
    
      const n = document.createElement("div");
      n.className = "chartRowIdx";
      n.textContent = String(idx);
    
      const nm = document.createElement("div");
      nm.className = "chartRowName";
      nm.textContent = name || "Nawyk";
    
      const badges = document.createElement("div");
      badges.className = "chartRowBadges";
    
      const bDone = document.createElement("div");
      bDone.className = "chartBadge done";
      bDone.innerHTML = `<span class="dot"></span><span>${donePct}%</span>`;
    
      const bFail = document.createElement("div");
      bFail.className = "chartBadge fail";
      bFail.innerHTML = `<span class="dot"></span><span>${failPct}%</span>`;
    
      badges.appendChild(bDone);
      badges.appendChild(bFail);
    
      row.appendChild(n);
      row.appendChild(nm);
      row.appendChild(badges);
    
      return row;
    }
    
    function renderChartModal(stats) {
      chartModalList.innerHTML = "";
      chartModalRange.textContent = chartRangeTxt.textContent || "";
    
      const list = stats.perHabit || [];
      list.forEach((h, i) => {
        chartModalList.appendChild(
          makeChartRow(i + 1, h.name, h.donePct, h.failPct)
        );
      });

      const summary = `
        Aktywność: ${stats.coverage}% komórek<br>
        Średnio na dzień: ✔ ${stats.donePerDay}, ✖ ${stats.failPerDay}
        `;
      $("chartModalSummary").innerHTML = summary;
    }


    function addTodo(dateISO, text) {
      const t = String(text || "").trim();
      if (!t) return;

      state.todos.push({
        id: crypto.randomUUID(),
        dateISO,
        text: t,
        done: false,
        createdAt: Date.now()
      });

      saveState();
      renderTodos();
    }

    function toggleTodo(id) {
      const it = state.todos.find(x => x.id === id);
      if (!it) return;
      it.done = !it.done;
      saveState();
      renderTodos();
    }

    function deleteTodo(id) {
      state.todos = state.todos.filter(x => x.id !== id);
      saveState();
      renderTodos();
    }

    function renderTodos() {
      if (todoTitleSub) {
      todoTitleSub.textContent = `• ${monthNamePL(state.viewMonth)} ${state.viewYear}`;
    }
      todoList.innerHTML = "";

      const items = [...state.todos].sort((a, b) => {
        if (a.dateISO !== b.dateISO) return a.dateISO.localeCompare(b.dateISO);
        return (a.createdAt || 0) - (b.createdAt || 0);
      });

      if (!items.length) {
        todoEmpty.style.display = "block";
        return;
      }
      todoEmpty.style.display = "none";

      for (const it of items) {
        const row = document.createElement("div");
        row.className = "todoItem";
        if (it.done) row.classList.add("todoDone");

        const left = document.createElement("div");
        left.className = "todoLeft";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.className = "todoCheck";
        cb.checked = !!it.done;
        cb.addEventListener("change", () => toggleTodo(it.id));

        const textBox = document.createElement("div");

        const txt = document.createElement("div");
        txt.className = "todoText";
        txt.textContent = it.text;

        const meta = document.createElement("div");
        meta.className = "todoMeta";
        meta.textContent = fmtPL(fromISO(it.dateISO));

        textBox.appendChild(txt);
        textBox.appendChild(meta);

        left.appendChild(cb);
        left.appendChild(textBox);

        const del = document.createElement("button");
        del.type = "button";
        del.className = "todoDel";
        del.textContent = "×";
        del.title = "Usuń";
        del.addEventListener("click", () => deleteTodo(it.id));

        row.appendChild(left);
        row.appendChild(del);

        todoList.appendChild(row);
      }
    }

    function renderCalendar() {
      calTitle.textContent = `${monthNamePL(state.viewMonth)} ${state.viewYear}`;
      calGrid.innerHTML = "";

      const days = buildMonthGrid(state.viewYear, state.viewMonth);
      const selected = getSelectedDateObj();
      const weekStart = startOfWeekMonday(selected);
      const weekEnd = addDays(weekStart, 6);

      for (const d of days) {
        const cell = document.createElement("button");
        cell.type = "button";
        cell.className = "calDay";

        const inMonth = d.getMonth() === state.viewMonth;
        if (!inMonth) cell.classList.add("calMuted");

        if (sameDay(d, selected)) cell.classList.add("calSelected");
        if (d >= weekStart && d <= weekEnd) cell.classList.add("calWeek");

        cell.textContent = String(d.getDate());

        cell.addEventListener("click", () => setSelectedDate(d));
        cell.addEventListener("dblclick", (e) => {
          e.preventDefault();
          setSelectedDate(d);
          openTodoModal(d);
        });

        calGrid.appendChild(cell);
      }
    }

    function cycleEntry(habitId, dateISO) {
      const key = `${habitId}|${dateISO}`;
      const cur = state.entries[key] ?? 0;

      let next = 0;
      if (cur === 0) next = 1;
      else if (cur === 1) next = -1;
      else next = 0;

      if (next === 0) delete state.entries[key];
      else state.entries[key] = next;

      saveState();
      renderHabits();
      renderChart();
    }

    function deleteHabit(habitId) {
      state.habits = state.habits.filter(h => h.id !== habitId);
      for (const k of Object.keys(state.entries)) {
        if (k.startsWith(habitId + "|")) delete state.entries[k];
      }
      saveState();
      renderHabits();
      renderChart();
    }

    function renderHabits() {
      const selected = getSelectedDateObj();
      const weekStart = startOfWeekMonday(selected);
      const weekDates = Array.from({ length: 7 }, (_, i) => addDays(weekStart, i));

      habRange.textContent = `${fmtPL(weekStart)} do ${fmtPL(addDays(weekStart, 6))}`;

      const trHead = document.createElement("tr");

      const thHabit = document.createElement("th");
      thHabit.textContent = "Nawyk";
      thHabit.className = "thHabit";
      trHead.appendChild(thHabit);

      const thDel = document.createElement("th");
      thDel.textContent = "";
      thDel.style.width = "44px";
      trHead.appendChild(thDel);

      for (const d of weekDates) {
        const th = document.createElement("th");
        th.className = "thDay";
        th.textContent = `${pad2(d.getDate())}.${pad2(d.getMonth() + 1)}`;
        if (sameDay(d, selected)) th.classList.add("thToday");
        trHead.appendChild(th);
      }

      habThead.innerHTML = "";
      habThead.appendChild(trHead);

      habTbody.innerHTML = "";
      for (const h of state.habits) {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.className = "tdHabit";

        const name = document.createElement("div");
        name.className = "habitName";
        name.contentEditable = "true";
        name.spellcheck = false;
        name.textContent = h.name;

        name.addEventListener("blur", () => {
          const v = name.textContent.trim();
          h.name = v.length ? v : "Nawyk";
          saveState();
        });
        name.addEventListener("keydown", (e) => {
          if (e.key === "Enter") { e.preventDefault(); name.blur(); }
        });

        tdName.appendChild(name);
        tr.appendChild(tdName);

        const tdDel = document.createElement("td");
        tdDel.className = "tdCell";

        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.className = "habitDel";
        delBtn.textContent = "×";
        delBtn.title = "Usuń nawyk";
        delBtn.addEventListener("click", () => deleteHabit(h.id));

        tdDel.appendChild(delBtn);
        tr.appendChild(tdDel);

        for (const d of weekDates) {
          const dateISO = toISO(d);
          const key = `${h.id}|${dateISO}`;
          const val = state.entries[key] ?? 0;

          const td = document.createElement("td");
          td.className = "tdCell";

          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "cellBtn";
          if (val === 1) btn.classList.add("cellDone");
          if (val === -1) btn.classList.add("cellFail");

          btn.addEventListener("click", () => cycleEntry(h.id, dateISO));
          td.appendChild(btn);
          tr.appendChild(td);
        }

        habTbody.appendChild(tr);
      }
    }

    function addHabit() {
      const name = habitName.value.trim();
      if (!name) return;
      state.habits.push({ id: crypto.randomUUID(), name });
      habitName.value = "";
      saveState();
      renderHabits();
      renderChart();
    }

    addHabitBtn.addEventListener("click", addHabit);
    habitName.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addHabit();
    });

    btnPrev.addEventListener("click", () => {
      let y = state.viewYear;
      let m = state.viewMonth - 1;
      if (m < 0) { m = 11; y -= 1; }
      setViewMonthYear(y, m);
    });

    btnNext.addEventListener("click", () => {
      let y = state.viewYear;
      let m = state.viewMonth + 1;
      if (m > 11) { m = 0; y += 1; }
      setViewMonthYear(y, m);
    });

    btnToday.addEventListener("click", () => {
      setSelectedDate(new Date());
    });

    todoClose.addEventListener("click", closeTodoModal);
    todoCancel.addEventListener("click", closeTodoModal);

    todoOverlay.addEventListener("click", (e) => {
      if (e.target === todoOverlay) closeTodoModal();
    });

    document.addEventListener("keydown", (e) => {
      if (todoOverlay.classList.contains("isOpen") && e.key === "Escape") closeTodoModal();
    });

    todoSave.addEventListener("click", () => {
      addTodo(todoDateInput.value, todoText.value);
      closeTodoModal();
    });
    chartDetailsBtn.addEventListener("click", () => {
      const s = computeChartStats();
      renderChartModal(s);
      openChartModal();
    });

    chartClose.addEventListener("click", closeChartModal);

    chartOverlay.addEventListener("click", (e) => {
      if (e.target === chartOverlay) closeChartModal();
    });

    document.addEventListener("keydown", (e) => {
      if (chartOverlay.classList.contains("isOpen") && e.key === "Escape") closeChartModal();
    });

    const expOnlySelected = $("expOnlySelected");
    const expAmount = $("expAmount");
    const expWhat = $("expWhat");
    const expCategory = $("expCategory");
    const expScore = $("expScore");
    const expPeriod = $("expPeriod");
    const expDate = $("expDate");
    const expAdd = $("expAdd");
    const expList = $("expList");
    const expSummary = $("expSummary");

    
    expAmount.addEventListener("input", () => {
     let v = expAmount.value;
     v = v.replace(/[^0-9.,]/g, "");

     const parts = v.split(/[.,]/);
     if (parts[0].length > 9) {
       parts[0] = parts[0].slice(0, 9);
     }

     expAmount.value = parts.length > 1
       ? parts[0] + "," + parts[1].slice(0, 2)
       : parts[0];
    });
    
    function moneyPL(n) {
      const x = Number(n);
      if (!Number.isFinite(x)) return "0,00 zł";
      return x.toFixed(2).replace(".", ",") + " zł";
    }

    function ensureExpenses() {
      if (!state.expenses) state.expenses = [];
    }

    function getExpenseFilterISO() {
      return state.selectedDate;
    }

    function addExpense() {
      ensureExpenses();

      const amt = Number(String(expAmount.value || "").replace(",", "."));
      const what = String(expWhat.value || "").trim();
      const dateISO = expDate.value || getExpenseFilterISO();
      
      if (!Number.isFinite(amt) || amt <= 0) return;
      if (String(Math.floor(amt)).length > 10) return;
      if (!what) return;

      state.expenses.push({
        id: crypto.randomUUID(),
        dateISO,
        amount: amt,
        what,
        category: expCategory.value,
        score: expScore.value,
        period: expPeriod.value,
        createdAt: Date.now()
      });

      expAmount.value = "";
      expWhat.value = "";
      expPeriod.value = "once";

      saveState();
      renderExpenses();
      renderCalendar();
    }

    function deleteExpense(id) {
      ensureExpenses();
      state.expenses = state.expenses.filter(x => x.id !== id);
      saveState();
      renderExpenses();
      renderCalendar();
    }

    function renderExpenses() {
      ensureExpenses();

      const filterISO = getExpenseFilterISO();
      expDate.value = filterISO;

      const items = [...state.expenses];

      items.sort((a, b) => {
        if (a.dateISO !== b.dateISO) return b.dateISO.localeCompare(a.dateISO);
        return (b.createdAt || 0) - (a.createdAt || 0);
      });

      const sum = items_slice_sum(items);
      expSummary.textContent = "Suma: " + moneyPL(sum);

      expList.innerHTML = "";

      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "todoEmpty";
        empty.textContent = "Brak wpisów.";
        expList.appendChild(empty);
        return;
      }

      for (const it of items) {
        const row = document.createElement("div");
        row.className = "expItem";

        const amt = document.createElement("div");
        amt.className = "expAmt";
        amt.textContent = moneyPL(it.amount);

        const whatBox = document.createElement("div");
        const what = document.createElement("div");
        what.textContent = it.what;
        const meta = document.createElement("div");
        meta.className = "expMeta";
        meta.textContent = fmtPL(fromISO(it.dateISO));
        whatBox.appendChild(what);
        whatBox.appendChild(meta);

        const cat = document.createElement("div");
        cat.className = "expTag";
        cat.textContent = it.category;

        const score = document.createElement("div");
        score.className = "expTag";
        score.textContent = scoreLabel(it.score);

        const per = document.createElement("div");
        per.className = "expTag";
        per.textContent = periodLabel(it.period);

        const del = document.createElement("button");
        del.type = "button";
        del.className = "expDel";
        del.textContent = "×";
        del.title = "Usuń";
        del.addEventListener("click", () => deleteExpense(it.id));

        row.appendChild(amt);
        row.appendChild(whatBox);
        row.appendChild(cat);
        row.appendChild(score);
        row.appendChild(per);
        row.appendChild(del);

        expList.appendChild(row);
      }
    }

    function items_slice_sum(items) {
      let s = 0;
      for (const it of items) s += Number(it.amount) || 0;
      return s;
    }

    function scoreLabel(v) {
      if (v === "A") return "A — Wysoki priorytet";
      if (v === "B") return "B — Konieczny";
      if (v === "C") return "C — Opcjonalny";
      return "D — Zbędny";
    }

    function periodLabel(v) {
      if (v === "weekly") return "Tygodniowe";
      if (v === "monthly") return "Miesięczne";
      if (v === "yearly") return "Roczne";
      return "Jednorazowe";
    }

    expAdd.addEventListener("click", addExpense);

    expWhat.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addExpense();
    });

    function monthRangeForSelected() {
    const d = getSelectedDateObj();
    const y = d.getFullYear();
    const m = d.getMonth();
    const start = new Date(y, m, 1);
    const end = new Date(y, m + 1, 0);
    return { start, end };
  }
  
  function rangeForChart() {
    const selected = getSelectedDateObj();
  
    if (state.chartMode === "month") {
      const { start, end } = monthRangeForSelected();
      return { start: startOfDay(start), end: startOfDay(end), daysCount: end.getDate() };
    }
  
    const weekStart = startOfWeekMonday(selected);
    return { start: startOfDay(weekStart), end: startOfDay(addDays(weekStart, 6)), daysCount: 7 };
  }
  
  function getEntryValue(habitId, dateISO) {
    const key = `${habitId}|${dateISO}`;
    return state.entries[key] ?? 0;
  }
  
  function computeChartStats() {
    const { start, end, daysCount } = rangeForChart();
    const totalCells = (state.habits?.length || 0) * daysCount;
  
  let done = 0;
  let fail = 0;

  const perHabit = state.habits.map(h => ({
    id: h.id,
    name: h.name,
    done: 0,
    fail: 0,
    donePct: 0,
    failPct: 0
  }));

  const perMap = Object.fromEntries(perHabit.map(x => [x.id, x]));

  for (let i = 0; i < daysCount; i++) {
    const d = addDays(start, i);
    const iso = toISO(d);

    for (const h of state.habits) {
      const v = getEntryValue(h.id, iso);

      if (v === 1) {
        done += 1;
        perMap[h.id].done += 1;
      } else if (v === -1) {
        fail += 1;
        perMap[h.id].fail += 1;
      }
    }
  }

  for (const x of perHabit) {
    x.donePct = daysCount > 0 ? Math.round((x.done / daysCount) * 100) : 0;
    x.failPct = daysCount > 0 ? Math.round((x.fail / daysCount) * 100) : 0;
  }
  
    const empty = Math.max(0, totalCells - done - fail);
  
    const coverage = totalCells > 0 ? Math.round(((done + fail) / totalCells) * 100) : 0;
    const donePerDay = daysCount > 0 ? (done / daysCount).toFixed(2) : "0.00";
    const failPerDay = daysCount > 0 ? (fail / daysCount).toFixed(2) : "0.00";
  
    return { start, end, daysCount, totalCells, done, fail, empty, coverage, donePerDay, failPerDay, perHabit };
  }
  
  function polarToCartesian(cx, cy, r, angleDeg) {
    const a = (angleDeg - 90) * Math.PI / 180;
    return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
  }
  
  function arcPath(cx, cy, r, startAngle, endAngle) {
    const start = polarToCartesian(cx, cy, r, endAngle);
    const end = polarToCartesian(cx, cy, r, startAngle);
    const large = (endAngle - startAngle) <= 180 ? "0" : "1";
    return `M ${start.x} ${start.y} A ${r} ${r} 0 ${large} 0 ${end.x} ${end.y}`;
  }
  
  function renderDonut(done, fail, empty) {
    const total = done + fail + empty;
  
    chartSvg.innerHTML = "";
  
    const cx = 110;
    const cy = 110;
    const r = 86;
  
    const ring = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    ring.setAttribute("cx", cx);
    ring.setAttribute("cy", cy);
    ring.setAttribute("r", r);
    ring.setAttribute("fill", "none");
    ring.setAttribute("stroke", "#3a3a3a");
    ring.setAttribute("stroke-width", "18");
    chartSvg.appendChild(ring);
  
    if (total <= 0) {
      const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
      t.setAttribute("x", cx);
      t.setAttribute("y", cy + 6);
      t.setAttribute("text-anchor", "middle");
      t.setAttribute("font-size", "14");
      t.setAttribute("fill", "#e7e7e7");
      t.textContent = "Brak danych";
      chartSvg.appendChild(t);
      return;
    }
  
    const parts = [
      { v: empty, stroke: "#555" },
      { v: fail, stroke: "#ff2f5d" },
      { v: done, stroke: "#2f9dff" }
    ].filter(p => p.v > 0);
  
    let angle = 0;
  
    for (const p of parts) {
      const span = (p.v / total) * 360;
      const startAngle = angle;
      const endAngle = angle + span;
    
      const path = document.createElementNS("http://www.w3.org/2000/svg", "path");
      path.setAttribute("d", arcPath(cx, cy, r, startAngle, endAngle));
      path.setAttribute("fill", "none");
      path.setAttribute("stroke", p.stroke);
      path.setAttribute("stroke-width", "18");
      path.setAttribute("stroke-linecap", "round");
    
      chartSvg.appendChild(path);
    
      angle = endAngle;
    }
  
    const inner = document.createElementNS("http://www.w3.org/2000/svg", "circle");
    inner.setAttribute("cx", cx);
    inner.setAttribute("cy", cy);
    inner.setAttribute("r", 58);
    inner.setAttribute("fill", "#2a2a2a");
    chartSvg.appendChild(inner);
  
    const center = document.createElementNS("http://www.w3.org/2000/svg", "text");
    center.setAttribute("x", cx);
    center.setAttribute("y", cy + 6);
    center.setAttribute("text-anchor", "middle");
    center.setAttribute("font-size", "16");
    center.setAttribute("fill", "#e7e7e7");
    center.textContent = `${Math.round((done / total) * 100)}%`;
    chartSvg.appendChild(center);
  }
  
  function syncChartTabs() {
    const isWeek = state.chartMode === "week";
    chartWeekBtn.classList.toggle("isActive", isWeek);
    chartMonthBtn.classList.toggle("isActive", !isWeek);
  }
  
  function renderChart() {
    const s = computeChartStats();
  
    chartDoneTxt.textContent = String(s.done);
    chartFailTxt.textContent = String(s.fail);
    chartEmptyTxt.textContent = String(s.empty);
  
    if (state.chartMode === "month") {
      chartRangeTxt.textContent = `${monthNamePL(getSelectedDateObj().getMonth())} ${getSelectedDateObj().getFullYear()}`;
    } else {
      chartRangeTxt.textContent = `${fmtPL(s.start)} - ${fmtPL(s.end)}`;
    }

    syncChartTabs();
    renderDonut(s.done, s.fail, s.empty);
  }
  
  chartWeekBtn.addEventListener("click", () => {
    state.chartMode = "week";
    saveState();
    renderChart();
  });
  
  chartMonthBtn.addEventListener("click", () => {
    state.chartMode = "month";
    saveState();
    renderChart();
  });

    const navDash = $("navDash");
    const navHabits = $("navHabits");
    const navTodo = $("navTodo");
    const navExpenses = $("navExpenses");

    const navAddHabits = $("navAddHabits");
    const navAddTodo = $("navAddTodo");
    const navAddExpenses = $("navAddExpenses");

    const navWishlist = $("navWishlist");
    const navAddWishlist = $("navAddWishlist");

    const boxTopA = document.querySelector(".box.topA");
    const tableBox = document.querySelector(".tableBox");
    const bottomBox = document.querySelector(".bottomBox");
    const wishWrap = document.querySelector(".wishWrap");

    const todoBox = document.getElementById("todoBox");
    const todoPanel = document.querySelector(".box.todoBox");

    todoPanel?.addEventListener("dblclick", (e) => {
      if (e.target.closest("button, input, textarea, select, .todoItem, .todoDel, .todoCheck")) return;
      openTodoModal(getSelectedDateObj());
    });

    function scrollToEl(el){
      if (!el) return;
      el.scrollIntoView({ behavior: "smooth", block: "start" });
    }

    function setNavActive(btn){
      document.querySelectorAll(".navItem").forEach(x => x.classList.remove("isActive"));
      if (btn) btn.classList.add("isActive");
    }

    const habitOverlay = $("habitOverlay");
    const habitModalName = $("habitModalName");
    const habitSave = $("habitSave");
    const habitClose = $("habitClose");
    const habitCancel = $("habitCancel");

    function openHabitModal(){
      habitModalName.value = "";
      habitOverlay.classList.add("isOpen");
      habitOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => habitModalName.focus(), 0);
    }

    function closeHabitModal(){
      habitOverlay.classList.remove("isOpen");
      habitOverlay.setAttribute("aria-hidden", "true");
    }

    function addHabitFromModal(){
      const name = habitModalName.value.trim();
      if (!name) return;
      state.habits.push({ id: crypto.randomUUID(), name });
      saveState();
      renderHabits();
      renderChart();
      closeHabitModal();
    }

    habitSave.addEventListener("click", addHabitFromModal);
    habitClose.addEventListener("click", closeHabitModal);
    habitCancel.addEventListener("click", closeHabitModal);
    habitOverlay.addEventListener("click", (e) => {
      if (e.target === habitOverlay) closeHabitModal();
    });

    document.addEventListener("keydown", (e) => {
      if (habitOverlay.classList.contains("isOpen") && e.key === "Escape") closeHabitModal();
    });

    habitModalName.addEventListener("keydown", (e) => {
      if (e.key === "Enter") addHabitFromModal();
    });

    const expOverlay = $("expOverlay");
    const expModalAmount = $("expModalAmount");
    const expModalWhat = $("expModalWhat");
    const expModalCategory = $("expModalCategory");
    const expModalScore = $("expModalScore");
    const expModalPeriod = $("expModalPeriod");
    const expModalDate = $("expModalDate");
    const expSaveBtn = $("expSave");
    const expCloseBtn = $("expClose");
    const expCancelBtn = $("expCancel");

    function openExpModal(){
      expModalAmount.value = "";
      expModalWhat.value = "";
      expModalCategory.value = "Jedzenie";
      expModalScore.value = "B";
      expModalPeriod.value = "once";
      expModalDate.value = state.selectedDate;

      expOverlay.classList.add("isOpen");
      expOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => expModalAmount.focus(), 0);
    }

    function closeExpModal(){
      expOverlay.classList.remove("isOpen");
      expOverlay.setAttribute("aria-hidden", "true");
    }

    expModalAmount.addEventListener("input", () => {
      let v = expModalAmount.value;
      v = v.replace(/[^0-9.,]/g, "");
      const parts = v.split(/[.,]/);
      if (parts[0].length > 9) parts[0] = parts[0].slice(0, 9);
      expModalAmount.value = parts.length > 1 ? parts[0] + "," + parts[1].slice(0, 2) : parts[0];
    });

    function addExpenseFromModal(){
      ensureExpenses();

      const amt = Number(String(expModalAmount.value || "").replace(",", "."));
      const what = String(expModalWhat.value || "").trim();
      const dateISO = expModalDate.value || state.selectedDate;

      if (!Number.isFinite(amt) || amt <= 0) return;
      if (String(Math.floor(amt)).length > 10) return;
      if (!what) return;

      state.expenses.push({
        id: crypto.randomUUID(),
        dateISO,
        amount: amt,
        what,
        category: expModalCategory.value,
        score: expModalScore.value,
        period: expModalPeriod.value,
        createdAt: Date.now()
      });

      saveState();
      renderExpenses();
      renderCalendar();
      closeExpModal();
    }

    expSaveBtn.addEventListener("click", addExpenseFromModal);
    expCloseBtn.addEventListener("click", closeExpModal);
    expCancelBtn.addEventListener("click", closeExpModal);
    expOverlay.addEventListener("click", (e) => {
      if (e.target === expOverlay) closeExpModal();
    });

    document.addEventListener("keydown", (e) => {
      if (expOverlay.classList.contains("isOpen") && e.key === "Escape") closeExpModal();
    });

    navDash.addEventListener("click", () => { setNavActive(navDash); scrollToEl(boxTopA); });
    navHabits.addEventListener("click", () => { setNavActive(navHabits); scrollToEl(tableBox); });
    navTodo.addEventListener("click", () => { setNavActive(navTodo); scrollToEl(todoBox); });
    navExpenses.addEventListener("click", () => { setNavActive(navExpenses); scrollToEl(bottomBox); });

    if (navWishlist) navWishlist.addEventListener("click", () => {
      setNavActive(navWishlist);
      scrollToEl(wishWrap || bottomBox);
    });

    if (navAddWishlist) navAddWishlist.addEventListener("click", (e) => {
      e.stopPropagation();
      setNavActive(navWishlist);
      openWishModal();
    });

    if (navWishlist) navWishlist.addEventListener("dblclick", () => {
      setNavActive(navWishlist);
      openWishModal();
    });


    function closeQuickAdd(){
      quickAddMenu.classList.remove("isOpen");
      quickAddMenu.setAttribute("aria-hidden", "true");
    }

    function toggleQuickAdd(){
      const open = quickAddMenu.classList.toggle("isOpen");
      quickAddMenu.setAttribute("aria-hidden", open ? "false" : "true");
    }

    navAddHabits.addEventListener("click", (e) => {
      e.stopPropagation();
      setNavActive(navHabits);
      openHabitModal();
    });

    navAddTodo.addEventListener("click", (e) => {
      e.stopPropagation();
      setNavActive(navTodo);
      openTodoModal(getSelectedDateObj());
    });

    navAddExpenses.addEventListener("click", (e) => {
      e.stopPropagation();
      setNavActive(navExpenses);
      openExpModal();
    });

    navTodo.addEventListener("dblclick", () => {
      setNavActive(navTodo);
      openTodoModal(getSelectedDateObj());
    });

    navHabits.addEventListener("dblclick", () => {
      setNavActive(navHabits);
      openHabitModal();
    });

    function renderAll() {
      renderCalendar();
      renderHabits();
      renderTodos();
      renderExpenses();
      renderChart();
      renderWishlist();
      pomoSyncUI();
    }

    function ensureWishlist() {
      if (!state.wishlist) state.wishlist = [];
    }

    const wishName = $("wishName");
    const wishPrice = $("wishPrice");
    const wishAdd = $("wishAdd");
    const wishList = $("wishList");

    const wishOverlay = $("wishOverlay");
    const wishModalName = $("wishModalName");
    const wishModalPrice = $("wishModalPrice");
    const wishSaveBtn = $("wishSave");
    const wishCloseBtn = $("wishClose");
    const wishCancelBtn = $("wishCancel");

    function openWishModal() {
      if (!wishOverlay) return;
      ensureWishlist();
      wishModalName.value = "";
      wishModalPrice.value = "";
      wishOverlay.classList.add("isOpen");
      wishOverlay.setAttribute("aria-hidden", "false");
      setTimeout(() => wishModalName.focus(), 0);
    }

    function closeWishModal() {
      if (!wishOverlay) return;
      wishOverlay.classList.remove("isOpen");
      wishOverlay.setAttribute("aria-hidden", "true");
    }

    function addWishFromModal() {
      ensureWishlist();

      const name = String(wishModalName.value || "").trim();
      const priceRaw = String(wishModalPrice.value || "").trim();
      if (!name) return;

      let price = null;
      if (priceRaw !== "") {
        const n = Number(String(priceRaw).replace(",", "."));
        if (!Number.isFinite(n) || n < 0) return;
        price = n;
      }

      state.wishlist.push({
        id: crypto.randomUUID(),
        name,
        price,
        createdAt: Date.now()
      });

      saveState();
      renderWishlist();
      closeWishModal();
    }

    // Listenery modala wishlist tylko raz
    if (wishSaveBtn) wishSaveBtn.addEventListener("click", addWishFromModal);
    if (wishCloseBtn) wishCloseBtn.addEventListener("click", closeWishModal);
    if (wishCancelBtn) wishCancelBtn.addEventListener("click", closeWishModal);

    if (wishOverlay) wishOverlay.addEventListener("click", (e) => {
      if (e.target === wishOverlay) closeWishModal();
    });

    document.addEventListener("keydown", (e) => {
      if (wishOverlay && wishOverlay.classList.contains("isOpen") && e.key === "Escape") closeWishModal();
    });

    if (wishModalPrice) wishModalPrice.addEventListener("keydown", (e) => { if (e.key === "Enter") addWishFromModal(); });
    if (wishModalName) wishModalName.addEventListener("keydown", (e) => { if (e.key === "Enter") addWishFromModal(); });

    function addWish() {
      ensureWishlist();

      const name = String(wishName.value || "").trim();
      const priceRaw = String(wishPrice.value || "").trim();

      if (!name) return;

      let price = null;
      if (priceRaw !== "") {
        const n = Number(String(priceRaw).replace(",", "."));
        if (!Number.isFinite(n) || n < 0) return;
        price = n;
      }

      state.wishlist.push({
        id: crypto.randomUUID(),
        name,
        price,
        createdAt: Date.now()
      });

      wishName.value = "";
      wishPrice.value = "";
      saveState();
      renderWishlist();
    }

    function deleteWish(id) {
      ensureWishlist();
      state.wishlist = state.wishlist.filter(x => x.id !== id);
      saveState();
      renderWishlist();
    }

    function renderWishlist() {
      ensureWishlist();
      wishList.innerHTML = "";

      const items = [...state.wishlist].sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

      if (!items.length) {
        const empty = document.createElement("div");
        empty.className = "todoEmpty";
        empty.textContent = "Brak wishlisty.";
        wishList.appendChild(empty);
        return;
      }

      for (const it of items) {
        const row = document.createElement("div");
        row.className = "wishItem";

        const left = document.createElement("div");
        left.className = "wishLeft";

        const nm = document.createElement("div");
        nm.className = "wishName";
        nm.textContent = it.name;

        const pr = document.createElement("div");
        pr.className = "wishPrice";
        pr.textContent = it.price === null ? "Cena: brak" : ("Cena: " + moneyPL(it.price));

        left.appendChild(nm);
        left.appendChild(pr);

        const del = document.createElement("button");
        del.type = "button";
        del.className = "wishDel";
        del.textContent = "×";
        del.title = "Usuń";
        del.addEventListener("click", () => deleteWish(it.id));

        row.appendChild(left);
        row.appendChild(del);

        wishList.appendChild(row);
      }
    }


    if (wishAdd) wishAdd.addEventListener("click", addWish);
    if (wishPrice) wishPrice.addEventListener("keydown", (e) => { if (e.key === "Enter") addWish(); });
    if (wishName) wishName.addEventListener("keydown", (e) => { if (e.key === "Enter") addWish(); });


    // ---------- Pomodoro ----------
    
    function ensurePomodoro() {
      if (!state.pomodoro) {
        state.pomodoro = {
          mode: "focus",
          durationsMin: { focus: 25, break: 5, long: 15 },
          remainingByMode: { focus: 25 * 60, break: 5 * 60, long: 15 * 60 },
          remainingSec: 25 * 60,
          isRunning: false,
          lastTick: 0,
          session: 0
        };
        return;
      }

      const p = state.pomodoro;
      if (!p.durationsMin) p.durationsMin = { focus: 25, break: 5, long: 15 };
      if (!p.remainingByMode) {
        p.remainingByMode = {
          focus: (Number(p.durationsMin.focus) || 25) * 60,
          break: (Number(p.durationsMin.break) || 5) * 60,
          long: (Number(p.durationsMin.long) || 15) * 60
        };
      }
      if (!p.mode) p.mode = "focus";

      if (typeof p.remainingSec !== "number") {
        p.remainingSec = p.remainingByMode[p.mode] ?? ((Number(p.durationsMin[p.mode]) || 25) * 60);
      }
      if (typeof p.isRunning !== "boolean") p.isRunning = false;
      if (typeof p.lastTick !== "number") p.lastTick = 0;
      if (typeof p.session !== "number") p.session = 0;

      if (typeof p.remainingByMode.focus !== "number") p.remainingByMode.focus = (Number(p.durationsMin.focus) || 25) * 60;
      if (typeof p.remainingByMode.break !== "number") p.remainingByMode.break = (Number(p.durationsMin.break) || 5) * 60;
      if (typeof p.remainingByMode.long !== "number") p.remainingByMode.long = (Number(p.durationsMin.long) || 15) * 60;
    }

    const pomoFocusBtn = $("pomoFocus");
    const pomoBreakBtn = $("pomoBreak");
    const pomoLongBtn = $("pomoLong");
    const pomoTimeEl = $("pomoTime");
    const pomoStartBtn = $("pomoStart");
    const pomoResetBtn = $("pomoReset");
    const pomoSessionEl = $("pomoSession");

    let pomoTimerId = null;
    let pomoEditInput = null;

    function pad2p(n) { return String(n).padStart(2, "0"); }

    function fmtTime(sec) {
      const s = Math.max(0, Math.floor(sec));
      const mm = Math.floor(s / 60);
      const ss = s % 60;
      return `${pad2p(mm)}:${pad2p(ss)}`;
    }

    function pomoStopInterval() {
      if (pomoTimerId) {
        clearInterval(pomoTimerId);
        pomoTimerId = null;
      }
    }

    function pomoStartInterval() {
      pomoStopInterval();
      pomoTimerId = setInterval(pomoTick, 250);
    }

    function pomoSyncUI() {
      ensurePomodoro();
      const p = state.pomodoro;

      if (pomoTimeEl) pomoTimeEl.textContent = fmtTime(p.remainingSec);
      if (pomoSessionEl) pomoSessionEl.textContent = String(p.session);

      if (pomoFocusBtn) pomoFocusBtn.classList.toggle("isActive", p.mode === "focus");
      if (pomoBreakBtn) pomoBreakBtn.classList.toggle("isActive", p.mode === "break");
      if (pomoLongBtn) pomoLongBtn.classList.toggle("isActive", p.mode === "long");

      if (pomoStartBtn) pomoStartBtn.textContent = p.isRunning ? "Pause" : "Start";
    }

    function pomoSaveRemaining() {
      ensurePomodoro();
      const p = state.pomodoro;
      p.remainingByMode[p.mode] = p.remainingSec;
    }

    function pomoSwitchMode(nextMode) {
      ensurePomodoro();
      const p = state.pomodoro;

      if (pomoEditInput) return;

      pomoSaveRemaining();

      p.mode = nextMode;
      p.remainingSec = p.remainingByMode[nextMode] ?? ((Number(p.durationsMin[nextMode]) || 1) * 60);

      p.isRunning = false;
      p.lastTick = 0;

      saveState();
      pomoStopInterval();
      pomoSyncUI();
    }

    function pomoCompleteCycle() {
      ensurePomodoro();
      const p = state.pomodoro;

      if (p.mode === "focus") {
        p.session += 1;
        const isLong = (p.session % 4 === 0);
        p.mode = isLong ? "long" : "break";
      } else {
        p.mode = "focus";
      }

      const mins = Number(p.durationsMin[p.mode]) || 1;
      p.remainingSec = Math.max(1, Math.round(mins * 60));
      p.remainingByMode[p.mode] = p.remainingSec;

      p.isRunning = false;
      p.lastTick = 0;

      saveState();
      pomoStopInterval();
      pomoSyncUI();
    }

    function pomoTick() {
      ensurePomodoro();
      const p = state.pomodoro;

      if (!p.isRunning) return;

      const now = Date.now();
      if (!p.lastTick) p.lastTick = now;

      const deltaMs = now - p.lastTick;
      if (deltaMs < 200) return;

      const deltaSec = Math.floor(deltaMs / 1000);
      if (deltaSec <= 0) return;

      p.lastTick += deltaSec * 1000;
      p.remainingSec -= deltaSec;

      if (p.remainingSec <= 0) {
        p.remainingSec = 0;
        p.remainingByMode[p.mode] = 0;
        saveState();
        pomoSyncUI();
        pomoCompleteCycle();
        return;
      }

      p.remainingByMode[p.mode] = p.remainingSec;
      saveState();
      pomoSyncUI();
    }

    function pomoToggleStart() {
      ensurePomodoro();
      const p = state.pomodoro;

      if (pomoEditInput) return;

      if (p.remainingSec <= 0) {
        const mins = Number(p.durationsMin[p.mode]) || 1;
        p.remainingSec = Math.max(1, Math.round(mins * 60));
        p.remainingByMode[p.mode] = p.remainingSec;
      }

      p.isRunning = !p.isRunning;
      p.lastTick = Date.now();

      saveState();
      pomoSyncUI();

      if (p.isRunning) pomoStartInterval();
      else pomoStopInterval();
    }

    function pomoReset() {
      ensurePomodoro();
      const p = state.pomodoro;

      if (pomoEditInput) return;

      const mins = Number(p.durationsMin[p.mode]) || 1;
      p.isRunning = false;
      p.lastTick = 0;
      p.remainingSec = Math.max(1, Math.round(mins * 60));
      p.remainingByMode[p.mode] = p.remainingSec;

      saveState();
      pomoStopInterval();
      pomoSyncUI();
    }

      function pomoCanInlineEdit() {
        ensurePomodoro();
        const p = state.pomodoro;
        return !p.isRunning && p.lastTick === 0;
      }

    function pomoParseInline(raw) {
      const t = String(raw || "").trim();
      if (!t) return null;

      if (/^\d+$/.test(t)) {
        const mins = Math.max(1, Math.min(240, Math.round(Number(t))));
        return { remainingSec: mins * 60, mins };
      }

      const m = t.match(/^(\d{1,3})\s*:\s*(\d{1,2})$/);
      if (m) {
        const mm = Math.max(0, Math.min(240, Number(m[1])));
        const ss = Math.max(0, Math.min(59, Number(m[2])));
        const total = Math.max(1, (mm * 60) + ss);
        const mins = Math.max(1, Math.min(240, Math.round(total / 60)));
        return { remainingSec: total, mins };
      }

      return null;
    }

    function pomoBeginInlineEdit() {
      if (!pomoTimeEl) return;
      if (!pomoCanInlineEdit()) return;
      if (pomoEditInput) return;

      ensurePomodoro();
      const p = state.pomodoro;

      const input = document.createElement("input");
      input.type = "text";
      input.inputMode = "numeric";
      input.autocomplete = "off";
      input.className = "pomoEdit";
      input.value = String(Math.max(1, Math.round((p.remainingSec || 60) / 60)));

      pomoTimeEl.replaceWith(input);
      pomoEditInput = input;

      input.focus();
      input.select();

      const cancel = () => {
        if (!pomoEditInput) return;
        pomoEditInput.replaceWith(pomoTimeEl);
        pomoEditInput = null;
        pomoSyncUI();
      };

      const commit = () => {
        if (!pomoEditInput) return;

        const parsed = pomoParseInline(pomoEditInput.value);
        if (parsed) {
          p.durationsMin[p.mode] = parsed.mins;
          p.remainingSec = parsed.remainingSec;
          p.remainingByMode[p.mode] = parsed.remainingSec;
          p.isRunning = false;
          p.lastTick = 0;
          saveState();
        }

        pomoEditInput.replaceWith(pomoTimeEl);
        pomoEditInput = null;
        pomoSyncUI();
      };

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") { e.preventDefault(); commit(); }
        if (e.key === "Escape") { e.preventDefault(); cancel(); }
      });
      input.addEventListener("blur", commit);
    }

    if (pomoFocusBtn) pomoFocusBtn.addEventListener("click", () => pomoSwitchMode("focus"));
    if (pomoBreakBtn) pomoBreakBtn.addEventListener("click", () => pomoSwitchMode("break"));
    if (pomoLongBtn) pomoLongBtn.addEventListener("click", () => pomoSwitchMode("long"));

    if (pomoStartBtn) pomoStartBtn.addEventListener("click", pomoToggleStart);
    if (pomoResetBtn) pomoResetBtn.addEventListener("click", pomoReset);

    if (pomoTimeEl) pomoTimeEl.addEventListener("click", pomoBeginInlineEdit);

    function pomoRestoreRunning() {
      ensurePomodoro();
      const p = state.pomodoro;

      if (!p.isRunning) {
        pomoSyncUI();
        return;
      }

      const now = Date.now();
      const last = p.lastTick || now;
      const deltaSec = Math.floor((now - last) / 1000);

      p.lastTick = now;
      if (deltaSec > 0) p.remainingSec -= deltaSec;

      if (p.remainingSec <= 0) {
        p.remainingSec = 0;
        p.remainingByMode[p.mode] = 0;
        p.isRunning = false;
        saveState();
        pomoSyncUI();
        pomoCompleteCycle();
        return;
      }

      p.remainingByMode[p.mode] = p.remainingSec;
      saveState();
      pomoSyncUI();
      pomoStartInterval();
    }

    // ---------- Navbar: szybkie dodanie Wishlist ----------
    function focusWishlistQuickAdd() {
      if (!bottomBox) return;
      bottomBox.scrollIntoView({ behavior: "smooth", block: "start" });
      setTimeout(() => { if (wishName) wishName.focus(); }, 250);
    }

    // Dwuklik na "Wydatki" w sidebarze: skacz do wishlisty i fokusuj input
    if (navExpenses) navExpenses.addEventListener("dblclick", (e) => {
      e.preventDefault();
      setNavActive(navExpenses);
      focusWishlistQuickAdd();
    });

    // Shift+klik na plusie przy "Wydatki": zamiast modala wydatków, szybkie dodanie do wishlisty
    if (navAddExpenses) navAddExpenses.addEventListener("click", (e) => {
      if (!e.shiftKey) return;
      e.preventDefault();
      e.stopPropagation();
      setNavActive(navExpenses);
      focusWishlistQuickAdd();
    });

    ensureWishlist();
    ensurePomodoro();
    pomoRestoreRunning();

    setNavActive(navDash);
    renderAll(); 

</script>

</body>
</html>